<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: pages.marionette.ir.js</title>
    
    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">
    
    <h1 class="page-title">Source: pages.marionette.ir.js</h1>
    
    


    
    <section>
        <article>
            <pre class="prettyprint source"><code>/*global SecondFunnel, Backbone, Marionette, imagesLoaded, console, broadcast */
/**
 * @module intentRank
 */
SecondFunnel.module("intentRank", function (intentRank, SecondFunnel) {
    "use strict";

    var consecutiveFailures = 0;

    intentRank.options = {
        'baseUrl': "http://intentrank-test.elasticbeanstalk.com/intentrank",
        'urlTemplates': {
            'campaign': "&lt;%=url%>/store/&lt;%=store.name%>/campaign/&lt;%=campaign%>/getresults",
            'content': "&lt;%=url%>/store/&lt;%=store.name%>/campaign/&lt;%=campaign%>/content/&lt;%=id%>/getresults"
        },
        'categories': {},
        'backupResults': [],
        'IRResultsCount': 10,
        'IRTimeout': 5000,
        'store': {},
        'content': []
    };

    intentRank.on('start', function () {
        // Any additional init declarations go here
        var options = SecondFunnel.options,
            page = options.page || {};

        _.extend(intentRank.options, {
            'baseUrl': options.IRSource || this.baseUrl,
            'store': options.store || {},
            'campaign': options.campaign,
            // @deprecated: options.categories will be page.categories
            'categories': page.categories || options.categories || {},
            'backupResults': options.backupResults || [],
            'IRResultsCount': options.IRResultsCount || 10,
            'IRTimeout': options.IRTimeout || 5000,
            'content': options.content || [],
            'filters': options.filters || []
        });

        broadcast('intentRankInitialized', intentRank);
        return this;
    });

    /**
     * Filter the content based on the selector
     * passed and the criteria/filters defined in the SecondFunnel options.
     *
     * @param {Array} content
     * @param selector {string}: (optional) no idea what this is.
     *                           I think it stands for additional filters.
     * @returns {Array} filtered content
     */
    intentRank.filter = function (content, selector) {
        var i, filter,
            filters = intentRank.options.filters || [];

        filters.push(selector);
        filters = _.flatten(filters);

        for (i = 0; i &lt; filters.length; ++i) {
            filter = filters[i];
            if (content.length === 0) {
                break;
            }
            switch (typeof filter) {
            case 'function':
                content = _.filter(content, filter);
                break;
            case 'object':
                content = _.where(content, filter);
                break;
            }
        }
        return content;
    };

    /**
     * general implementation
     */
    intentRank.getResults = function () {
        try {
            var online = !SecondFunnel.option('page:offline', false);
            if (online) {
                return intentRank.getResultsOnline.apply(intentRank, arguments);
            }
        } catch (e) {}
        return intentRank.getResultsOffline.apply(intentRank, arguments);
    };

    /**
     * @param overrides (unused)
     * @returns something $.when() accepts
     */
    intentRank.getResultsOffline = function (overrides) {
        // instantly mark the deferral as complete.
        return _.chain(intentRank.options.backupResults)
            .filter(intentRank.filter)
            .shuffle()
            .first(intentRank.options.IRResultsCount)
            .value();
    };

    /**
     * @param overrides
     * @returns $.Deferred()
     */
    intentRank.getResultsOnline = function (overrides) {
        var ajax, deferred, opts, uri, backupResults,
            irFailuresAllowed = SecondFunnel.option('IRFailuresAllowed', 5);

        // build a one-off options object for the request.
        opts = $.extend(true, {}, intentRank.options, {
            'url': intentRank.options.baseUrl
        });
        $.extend(opts, overrides);

        uri = _.template(opts.urlTemplates[opts.type || 'campaign'], opts);
        backupResults = _.chain(opts.backupResults)
            .filter(intentRank.filter)
            .shuffle()
            .first(opts.IRResultsCount)
            .value();

        // http://stackoverflow.com/a/18986305/1558430
        deferred = new $.Deferred();

        if (consecutiveFailures > irFailuresAllowed) {
            // API is dead. serve backup results instantly
            deferred.resolve([]);  // deferred.resolve([backupResults]); // TODO: remove
        } else {
            ajax = ($.jsonp || $.ajax)({
                'url': uri,
                'data': {
                    'results': opts.IRResultsCount
                },
                'contentType': "application/javascript",
                'dataType': 'jsonp',
                'callbackParameter': 'callback',  // $.jsonp only; $.ajax uses 'jsonpCallback'
                'timeout': opts.IRTimeout
            });
            ajax.done(function (results) {
                consecutiveFailures = 0;  // reset

                return deferred.resolve(
                    // => list of n qualifying products
                    _.chain(results || opts.backupResults)
                        .filter(intentRank.filter)
                        .shuffle()
                        // trim the number of results if IR returns too many
                        .first(opts.IRResultsCount)
                        .value()
                );
            });
            ajax.fail(function (jqXHR, textStatus, errorThrown) {
                // $.jsonp calls this func as function (jqXHR, textStatus)
                console.error('AJAX / JSONP ' + textStatus + ': ' +
                    (errorThrown || jqXHR.url));

                consecutiveFailures++;

                if (consecutiveFailures > irFailuresAllowed) {
                    console.error(
                        'Too many consecutive endpoint failures. ' +
                        'All subsequent results will be backup results.');
                }

                return deferred.resolve(backupResults);
            });
        }

        // promises are shared w/ other objects, while deferred should be
        // kept private, says the internet
        return deferred.promise();
    };

    intentRank.changeCategory = function (category) {
        // Change the category
        if (!_.findWhere(intentRank.options.categories,
            {'id': Number(category)})) {
            // requested category not configured for this page
            console.warn('Category ' + category + ' not found');
            return intentRank;
        }

        broadcast('intentRankChangeCategory', category, intentRank);

        intentRank.options.campaign = category;
        return intentRank;
    };
});
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Modules</h3><ul><li><a href="module-core.html">core</a></li><li><a href="module-intentRank.html">intentRank</a></li><li><a href="module-layoutEngine.html">layoutEngine</a></li><li><a href="module-sharing.html">sharing</a></li><li><a href="module-support.html">support</a></li><li><a href="module-tracker.html">tracker</a></li><li><a href="module-utils.html">utils</a></li><li><a href="module-viewport.html">viewport</a></li></ul><h3>Classes</h3><ul><li><a href="module-core-core.Discovery.html">Discovery</a></li></ul><h3>Global</h3><ul><li><a href="global.html#_exists">_exists</a></li><li><a href="global.html#debugOp">debugOp</a></li><li><a href="global.html#determine">determine</a></li><li><a href="global.html#failsafe">failsafe</a></li><li><a href="global.html#isAniPad">isAniPad</a></li><li><a href="global.html#mobile">mobile</a></li><li><a href="global.html#option">option</a></li><li><a href="global.html#receive">receive</a></li><li><a href="global.html#reInitialize">reInitialize</a></li><li><a href="global.html#scale">scale</a></li><li><a href="global.html#touch">touch</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-dev</a> on Wed Sep 25 2013 17:14:06 GMT-0400 (EDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
