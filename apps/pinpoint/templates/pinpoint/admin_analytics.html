{% extends "pinpoint/admin_base.html" %}
{% load staticfiles %}

{% block title %}
    Analytics
{% endblock %}

{% block page_title %}
    Analytics
{% endblock %}

{% block extra_head %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static "css/jquery-ui.css" %}">

    <style>
        .container_12 .inner_content {
            padding: 0;
        }

        .top_analytics_menu {
            background-color: #fff;
            padding: 20px 0 0 20px;
            margin: 0;
            height: 50px;
            width: 920px;

            box-shadow: 0px 0px 5px #888;
        }

        .page_selector {
            display: inline;
        }

        .page_selector, .page_selector select {
            font-size: 18px;
        }

        .range_selector {
            display: inline;
            margin-left: 20px;
        }

        .range_selector input {
            font-size: 12px;
            padding: 3px;
            width: 80px;
        }

        .section_content {
            margin-left: 0;
        }

        .section_overview {
            border-right: 1px solid #d6d6d6;
            border-bottom: 1px solid #d6d6d6;
            margin-left: 0;
        }

        .section_overview_block {
            padding: 10px;
            border-top: 1px solid #d6d6d6;
        }

        .section_overview_block.selected, .section_overview_block:hover {
            background-color: #fff;
            cursor: pointer;
        }

        .section_overview_title {
            font-size: 18px;
        }

        .section_overview_metrics {
            font-size: 14px;
        }

        .section_overview_metrics ul {
            list-style: none;
        }

        .metric_overview {
            font-weight: bold;
        }

        .section_data {
            padding-top: 10px;
        }

        .data_title {
            font-size: 24px;
        }

        .data_metric {
            margin-top: 20px;
            margin-bottom: 40px;
        }

        .metric_title {
            font-size: 16px;
        }

        .top_product, .top_product:last-child {
            border: 1px solid #a3a3a3;
        }

        #top_engaging_products {
            margin-top: 10px;
        }

        .top_product {
            display: block;
            background-color: #fdfdfd;
            border-bottom: none;
            padding: 10px;
            width: 380px;
        }

        .top_product .name {
            width: 150px;
            float: left;
            font-weight: bolder;
            margin-right: 15px;
        }

        .top_product .image img {
            float: left;
            width: 75px;
            height: 75px;
            margin-right: 15px;
        }

        .clear {
            clear: both;
        }

        dl {
            width: 300px;
        }

        /* bar graph styling */
        dt {
            float: left;
            padding: 4px;
        }

        .bar {
            margin-bottom: 10px;
            margin-left: 80px;
            color: #fff;
            padding: 4px;
            text-align: center;
            background-color: #7C9B5F;
            border-radius: 2px;
        }

        .progress-label {
            float: left;
            margin-left: 50%;
            margin-top: 5px;
            font-weight: bold;
            text-shadow: 1px 1px 0 #fff;
        }

    </style>
{% endblock %}

{% block extra_js_includes %}
    <script src="{% static "js/jquery-ui.js" %}"></script>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
{% endblock %}

{% block top_section %}
    <nav class="grid_3 prefix_9">
        <ul>
            {% if store %}
                <li><a href="{% url store-admin store.id %}">Pages</a></li>
                <li class="selected"><a href="{% url analytics-store-admin store.id %}">Analytics</a></li>
            {% else %}
                <li><a href="{% url store-admin campaign.store.id %}">Pages</a></li>
                <li class="selected"><a href="#">Analytics</a></li>
            {% endif %}
        </ul>
    </nav>
{% endblock %}

{% block document_ready %}
    var app = (function ($) {
        var api, init, settings, setUpListeners, getDateRange,
            injectAnalyticsData, insertTopProduct, insertToBarGraph,
            loadAnalytics, map, cache;

        settings = {
            "store_id": "{{ store.id }}",
            "campaign_id": "{{ campaign.id }}"
        };

        cache = (function () {
            var get, set, hasLocalStorage, localData = {};

            hasLocalStorage = function () {
                try {
                    return 'localStorage' in window && window['localStorage'] !== null;
                } catch (e) {
                    return false;
                }
            };

            get = function (key) {
                if (hasLocalStorage()) {
                    return JSON.parse(localStorage.getItem(key));
                }

                if (key in localData) {
                    return localData[key];
                }

                return null;
            };

            set = function (key, value) {
                if (hasLocalStorage()) {
                    localStorage.setItem(key, JSON.stringify(value));
                } else {
                    localData[key] = value;
                }
            };

            return {
                "get": get,
                "set": set
            };
        }());

        map = function (func, iterable) {
            var results = [], res, key;

            for (key in iterable) {
                res = func(key, iterable[key]);

                if (res !== undefined) {
                    results.push(res);
                }
            }

            return results;
        };

        api = (function () {
            var uris = {
                'products': "/api/assets/v1/product/%pid%/?store={{ store.id }}&format=json",
                'products_media': "/api/assets/v1/product_media/?store={{ store.id }}&product=%pid%&format=json"
            }, getProduct, getProducts, fetchProduct;

            getProduct = function (pid, callback) {
                var product = cache.get(pid);

                if (product === null) {
                    fetchProduct(pid, callback);
                } else {
                    callback(product);
                }
            };

            getProducts = function (pids, step, callback) {
                var result = [];

                if (pids.length == 0) {
                    callback(result);
                }

                map(function (i, pid) {
                    getProduct(pid, function (product) {
                        result.push(product);

                        step(result.length, pids.length);

                        if (result.length == pids.length) {
                            callback(result);
                        }
                    });
                }, pids);
            };

            fetchProduct = function (pid, callback) {
                $.ajax({
                    url: uris.products.replace("%pid%", pid),
                    dataType: "json",
                    success: function (data) {
                        cache.set(data.id, data);

                        $.ajax({
                            url: uris.products_media.replace("%pid%", pid),
                            dataType: "json",
                            success: function (data) {
                                var prod = cache.get(pid);

                                if (data.meta.total_count > 0) {
                                    prod.media = data.objects[0];
                                    cache.set(pid, prod);
                                }

                                callback(prod);
                            }
                        });
                    }
                });
            };

            return {
                "getProduct": getProduct,
                "getProducts": getProducts
            };
        }());

        loadAnalytics = function (o) {
            var request = {
                "range": $(".range option:selected").val()
            };

            $(".no_data").show();

            // set request values based on what's passed it
            if (o !== undefined) {
                request.campaign_id = o.campaign_id || settings.campaign_id;
                request.store_id = o.store_id || settings.store_id;

                settings.campaign_id = request.campaign_id;
                settings.store_id = request.store_id;

            // or based on default values if nothing is passed in
            } else {
                request.campaign_id = settings.campaign_id;
                request.store_id = settings.store_id;
            }

            // pass only one of the values down the wire
            if (request.campaign_id) {
                delete request.store_id;
            }

            if (request.store_id) {
                delete request.campaign_id;
            }

            $.ajax({
                url: "{% url ajax-analytics-pinpoint %}",
                dataType: "json",
                data: request,
                success: function (data) {
                    injectAnalyticsData(data);
                }
            });
        };

        injectAnalyticsData = function (data) {
            var sortables = {
                    'engaged_products': [],
                    'sharing_products': [],
                    'sharing_source': []
                },

                totals = {
                    interactions: {
                        all: data.engagement['total-interactions'].totals.date.all,
                        product: data.engagement['product-interactions'].totals.date.all,
                        content: data.engagement['content-interactions'].totals.date.all,
                    },
                    shares: data.sharing['total-shares'].totals.date.all,
                    visitors: data.awareness['awareness-visitors'].totals.date.all,
                    pageviews: data.awareness['awareness-pageviews'].totals.date.all,
                    bounce_rate: Math.round(data.awareness['awareness-bounce_rate'].totals.date.all)
                },

                top_lists = {
                    'engaged_products': data.engagement['inpage-openpopup'].totals.product_id,
                    'sharing_products': data.sharing['share-clicked'].totals.product_id,
                    'sharing_source': data.sharing['share-clicked'].totals.meta
                },

                cat_slug, metric_slug,

                roundNumber = function (number, digits) {
                    var multiple = Math.pow(10, digits);
                    var rndedNum = Math.round(number * multiple) / multiple;
                    if (rndedNum === Infinity || isNaN(rndedNum)) {
                        return 0;
                    }
                    return rndedNum;
                };

            // insert totals for metrics into the sidebar
            for (cat_slug in data) {
                for (metric_slug in data[cat_slug]) {
                    var perc_suffix = "";
                    if (metric_slug == "awareness-bounce_rate") {
                        perc_suffix = "%";
                    }

                    // display totals in the sidebar on in the content section
                    $(".metric_overview[data-metric='" + metric_slug + "']").html(
                        Math.round(data[cat_slug][metric_slug].totals.date.all) + perc_suffix
                    );
                }
            }

            // TODO temp for awareness
            $("#total_visitors").html("<strong>Visitors:</strong> " + totals.visitors);
            $("#total_pageviews").html("<strong>Pageviews:</strong> " + totals.pageviews);
            $("#awareness-bounce_rate").html("<strong>Bounce Rate:</strong> " + totals.bounce_rate + "%");

            $("div[class='no_data'][data-metric='total_visitors']").hide();
            $("div[class='no_data'][data-metric='total_pageviews']").hide();
            $("div[class='no_data'][data-metric='awareness-bounce_rate']").hide();

            // These metrics aren't calculated by the backend atm, hence the ugly implementation
            $(".per-visitor").remove();

            $(".section_overview_block:first .section_overview_metrics ul").append(
                "<li class='per-visitor'><span class='metric_overview' data-metric='interactions-per-visitor'>" + roundNumber(totals.interactions.all / totals.visitors, 2) + "</span> Interactions per visit</li>");


            $(".section_overview_block:nth-child(2) .section_overview_metrics ul").append(
                "<li class='per-visitor'><span class='metric_overview' data-metric='shares-per-visitor'>" + roundNumber(totals.shares / totals.visitors, 2) + "</span> Shares per visit</li>");

            // construct lists of sorted (desc) (pid, count) pairs
            map(function (key, list) {
                sortables[key] = map(function (pid, count) {
                    if (pid !== "all" && pid !== "null") {
                        return [pid, count];
                    }
                }, list);

                sortables[key].sort(function (a, b) {
                    return a[1] - b[1];
                });

                sortables[key].reverse();

            }, top_lists);

            // clear out top lists
            $("#top_engaging_products").html("");
            $("#top_shared_products").html("");
            $("#share_destinations").html("");

            var pids = map(function(i, pair) {
                return pair[0];
            }, sortables.engaged_products);

            api.getProducts(pids, function (current, total) {
                $(".progressbar").progressbar("value", Math.round(current / total * 100));
            }, function () {
                // hide progress bar and show data
                $(".section_metrics").slideDown();
                $(".progressbar").slideUp();

                // inject top engaged products
                map(function (i, pair) {
                    insertTopProduct(
                        $("#top_engaging_products"),
                        "Interactions",
                        pair[0],
                        pair[1],
                        totals.interactions.product
                    );
                }, sortables.engaged_products.slice(0, 5));

                // inject top shared products
                map(function (i, pair) {
                    insertTopProduct(
                        $("#top_shared_products"),
                        "Shares",
                        pair[0],
                        pair[1],
                        totals.shares
                    );
                }, sortables.sharing_products.slice(0, 5));

                // inject top share destinations
                map(function (i, pair) {
                    insertToBarGraph(
                        $("#share_destinations"),
                        pair[0],
                        pair[1],
                        totals.shares
                    );
                }, sortables.sharing_source);
            });
        };

        insertToBarGraph = function ($parent, title, count, total) {
            var $title = $("<dt>").html(title),
                $bar,
                percentage = Math.round(count / total * 100) + "%";

            $bar = $("<dd>").append(
                $("<div>").addClass("bar").css("width", percentage).html(count + " (" + percentage + ")")
            );

            $parent.append($title).append($bar);

            $("div[class='no_data'][data-metric='" + $parent.attr("id") + "']").hide();
        };

        insertTopProduct = function ($parent, verb, pid, count, total) {
            var product,
                $box = $("<div>").addClass("top_product"),
                $count;

            api.getProduct(pid, function(product) {
                $name = $("<div>").addClass("name").html(product.name);

                $image = $("<div>").addClass("image").append(
                    $("<img>").attr("src",
                    product.media.hosted || product.media.remote
                ));

                $count = $("<div>").addClass("count").html(verb + ": " + count + " (" + Math.round(count / total * 100) + "%)");

                $box.append($name).append($image).append($count).append($("<div>").addClass("clear"));
                $parent.append($box);

                $("div[class='no_data'][data-metric='" + $parent.attr("id") + "']").hide();
            });
        };

        setUpListeners = function () {
            // ajax loading indicator
            $(".progressbar").progressbar({
                value: false,
                change: function() {
                    $(".progress-label").text( $(".progressbar").progressbar( "value" ) + "%" );
                },
                complete: function() {
                    $(".progress-label").text( "Complete!" );
                }
            });

            // select analytics category ui
            $(".section_overview_block").click(function () {
                $(".data_category").hide();
                $("div[data-cid='" + $(this).data("cid") + "']").show();

                $(".section_overview_block").removeClass("selected");
                $(this).addClass("selected");
            });

            // change date range
            $(".range").change(function () {
                loadAnalytics();
            });

            // change campaign from the top menu
            $("#campaign_list").change(function () {
                loadAnalytics({
                    'campaign_id': $(this).find("option:selected").attr("value")
                });
            });
        };

        init = function () {
            // create UI and event listeners
            setUpListeners();

            // load and inject data
            loadAnalytics();
        };

        return {
            "init": init
        };
    }(jQuery));

    google.load("visualization", "1", {
        packages: ["corechart", "table"],
        callback: function() {
            app.init();
        }
    });

{% endblock %}

{% block content %}
    <div class="top_analytics_menu">
        <div class="page_selector">
            <label for="campaign_list">Page:</label>
            <select id="campaign_list" name="campaign_list">
                {% for c in store.campaign_set.all %}
                    <option value="{{ c.id }}" {% if c.id == campaign.id %}selected{% endif %}>{{ c.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="range_selector">
            <select name="range" class="range">
                <option value="total" selected>Total</option>
                <option value="month">Past month</option>
                <option value="two_weeks">Past two weeks</option>
                <option value="week">Past week</option>
                <option value="day">Past day</option>
            </select>
        </div>
    </div>

    <div class="grid_12 section_content">
        <div class="grid_3 section_overview">
            {% for category in categories %}
                <div class="section_overview_block {% if forloop.first %}selected{% endif %}" data-cid="{{ category.id }}">
                    <div class="section_overview_title">
                        {{ category.name }}
                    </div>

                    <div class="section_overview_metrics">
                        <ul>
                        {% regroup category.categoryhasmetric_set.all by metric as metric_list %}
                        {% for metric in metric_list %}
                            {% with metric.list|first as metric_meta %}
                                {% if metric.grouper.enabled %}
                                    {% if metric_meta.display %}
                                    <li>
                                        <span class="metric_overview" data-metric="{{ metric.grouper.slug }}"></span>
                                        {{ metric.grouper.name }}
                                    </li>
                                    {% endif %}
                                {% endif %}
                            {% endwith %}
                        {% endfor %}
                        </ul>
                    </div>
                </div>
            {% endfor %}
        </div>

        <div class="grid_8 section_data">
            <div class="progressbar"><div class="progress-label">Loading...</div></div>

            <div class="section_metrics" style="display: none;">
            {% for category in categories %}
                <div class="data_category" data-cid="{{ category.id }}" {% if not forloop.first %}style="display: none;"{% endif %}>
                    <div class="data_title">
                        {{ category.name }}
                    </div>

                    <div class="data_metrics">
                        {% if category.name == "Engagement" %}
                            <div class="data_metric">
                                <div class="metric_title">Top Engaging Products</div>
                                <div class="metric_content" id="top_engaging_products"></div>

                                <div class="no_data" data-metric="top_engaging_products">
                                    <p>No engaged products yet.</p>
                                </div>
                            </div>

                            <!-- <div class="data_metric">
                                <div class="metric_title">Engagement per Source</div>
                            </div>

                            <div class="data_metric">
                                <div class="metric_title">Interaction Types</div>
                            </div> -->

                        {% elif category.name == "Sharing" %}

                            <div class="data_metric">
                                <div class="metric_title">Top Shared Products</div>
                                <div class="metric_content" id="top_shared_products"></div>

                                <div class="no_data" data-metric="top_shared_products">
                                    <p>No shared products yet.</p>
                                </div>
                            </div>

                            <div class="data_metric">
                                <div class="metric_title">Share Destinations</div>
                                <dl class="bar_graph" id="share_destinations"></dl>

                                <div class="no_data" data-metric="top_shared_products">
                                    <p>No shared products yet.</p>
                                </div>
                            </div>

                            <!-- <div class="data_metric">
                                <div class="metric_title">Sources of Shares</div>

                                <div class="no_data" data-metric="top_shared_products">
                                    <p>No shared products yet.</p>
                                </div>
                            </div> -->
                        {% elif category.name == "Awareness" %}
                            <div class="data_metric">
                                <div class="metric_title">Total Visitors</div>
                                <div class="metric_content" id="total_visitors"></div>

                                <div class="no_data" data-metric="total_visitors">
                                    <p>No visitors yet.</p>
                                </div>
                            </div>

                            <div class="data_metric">
                                <div class="metric_title">Total Pageviews</div>
                                <div class="metric_content" id="total_pageviews"></div>

                                <div class="no_data" data-metric="total_pageviews">
                                    <p>No visitors yet.</p>
                                </div>
                            </div>

                            <div class="data_metric">
                                <div class="metric_title">Average Bounce Rate</div>
                                <div class="metric_content" id="awareness-bounce_rate"></div>

                                <div class="no_data" data-metric="awareness-bounce_rate">
                                    <p>No data yet.</p>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
            </div>
        </div>
    </div>
{% endblock %}
