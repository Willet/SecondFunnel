{% extends "pinpoint/admin_base.html" %}
{% load staticfiles %}

{% block title %}
    Analytics
{% endblock %}

{% block page_title %}
    Analytics
{% endblock %}

{% block extra_head %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static "css/smoothness/jquery-ui.css" %}">
    <link rel="stylesheet" href="{% static "css/tipsy.css" %}">
    <link rel="stylesheet" href="{% static "pinpoint/css/admin_analytics.css" %}">
{% endblock %}

{% block extra_js_includes %}
    <script type="text/javascript">
        // supply analytics variables. must come before utils.js
        var analyticsSettings = {
            "ajaxURL": "{% url ajax-analytics-pinpoint %}",
            "store_id": "{{ store.id }}",
            "campaign_name": "{{ campaign.name }}",
            "campaign_id": "{{ campaign.default_intentrank.id }}"
        };
    </script>
    <script src="{% static "js/jquery-ui.js" %}"></script>
    <script src="{% static "js/d3.v3.min.js" %}"></script>
    <script src="{% static "js/jquery.tipsy.js" %}"></script>
    <script src="{% static "js/underscore.js" %}"></script>
    <script src="{% static "pinpoint/js/mediator.js" %}"></script>
    <script src="{% static "pinpoint/js/utils.js" %}"></script>
    <script src="{% static "pinpoint/js/charting.js" %}"></script>
    <script src="{% static "pinpoint/js/admin_analytics.js" %}"></script>

    <script>
        function truncate(str, len) {
            if (str.length > len) {
                return str.slice(0, len - 1) + "&hellip;";
            } else {
                return str;
            }
        }

        function pluralize(word, count) {
            if (count > 1) {
                return word + "s";
            }
            return word;
        }

        // start (explicitly-required) module
        Willet.analytics.init(analyticsSettings);
    </script>
{% endblock %}

{% block top_section %}
    {% include 'pinpoint/admin_tabs.html' with selected='analytics' %}
{% endblock top_section %}

{% block content %}
    <script type="text/template" id="top_list_item">
        <tr>
            <td><img src="<%= image %>"></td>
            <td><span class="caption_left"><%= caption %></span>
                <span class="caption_right"><%= truncate(name, 30) %></span>
            </td>
        </tr>
    </script>
    <script type="text/template" id="top_product_list_item">
        <tr>
            <td><img src="<%= image %>"></td>
            <td>
                <% if (total > 0 && count > 0 && total > count) { %>
                    <span class="caption_left"><%= caption %></span>
                    <span class="caption_right"><%= truncate(name, 30) %></span>
                <% } else { %>
                    <span class="caption_left bolder"><%= truncate(name, 30) %></span>
                    <br>
                    <span class="metric_count"><%= count %> <%= pluralize(verb, count) %></span>
                <% } %>
            </td>
        </tr>
    </script>

    <script type="text/template" id="video_item">
        <% Willet.mediaAPI.getObject("video_gdata", data, function (video_data) { %>
        <tr>
            <td><a href="http://www.youtube.com/watch?v=<%= data %>" title="<%= video_data.entry.title.$t %>" target="_blank"><img class="youtube_thumb" src="<%= video_data.entry['media$group']['media$thumbnail'][0].url %>"></a></td>
            <td><%= caption %></td>
        </tr>
        <% }); %>
    </script>

    <script type="text/template" id="count_with_percentage">
        <% if (total > 0 && count > 0 && total > count) { %>
            <span class="metric_perc"><%= ((count / total) * 100 || 0).toFixed(0) %>%</span><br><span class="metric_count"><%= count %> <%= pluralize(verb, count) %></span>
        <% } else { %>
            <span class="metric_perc">&nbsp;</span><br><span class="metric_count"><%= count %> <%= pluralize(verb, count) %></span>
        <% } %>
    </script>

    <script type="text/template" id="single_value_t">
        <span class="large_count"><%= value %></span>
    </script>

    <div class="top_analytics_menu">
        <div class="page_selector">
            <label for="campaign_list">Page:</label>
            <select id="campaign_list" name="campaign_list">
                {% for c in store.live_campaigns %}
                    {% if campaign %}
                        <option value="{{ c.id }}" {% if c.id == campaign.id %}selected{% endif %}>{{ c.name }}</option>
                    {% else %}
                        <option value="{{ c.id }}" {% if forloop.last %}selected{% endif %}>{{ c.name }}</option>
                    {% endif %}
                {% endfor %}
            </select>
        </div>

        <div class="range_selector">
            <select name="range" class="range">
                <option value="total" selected>Total</option>
                <option value="month">Past month</option>
                <option value="two_weeks">Past two weeks</option>
                <option value="week">Past week</option>
                <option value="day">Past day</option>
            </select>
        </div>
    </div>

    <div class="grid_3 section_overview">
        {% for category in categories %}
            <div class="grid_3 section_overview_block {% if category.default %}selected{% endif %}" data-cid="{{ category.id }}">
                <div class="section_overview_title">
                    {{ category.name }}
                </div>

                <div class="section_overview_metrics">
                    <ul>
                    {% regroup category.categoryhasmetric_set.all by metric as metric_list %}
                    {% for metric in metric_list %}
                        {% with metric.list|first as metric_meta %}
                            {% if metric.grouper.enabled %}
                                {% if metric_meta.display %}
                                <li {% if metric_meta.is_meta %}class="meta_metric"{% endif %}>
                                    <span class="metric_overview" data-metric="{{ metric.grouper.slug }}"></span>
                                    {{ metric.grouper.name }}
                                </li>
                                {% endif %}
                            {% endif %}
                        {% endwith %}
                    {% endfor %}
                    </ul>
                </div>
            </div>
        {% endfor %}
    </div>

    <div class="grid_8 section_content">
        <div class="progressbar"><div class="progress-label">Loading...</div></div>
        <div class="hidden ajax error ui-state-error">
            An error occurred while retrieving your data.
        </div>
        <div class="section_metrics" style="display: none;">

            {% for category in categories %}
                <div class="data_category" data-cid="{{ category.id }}" {% if not category.default %}style="display: none;"{% endif %}>
                    {% if category.name == "Engagement" %}
                        <div class="grid_4 data_metric round shadow">
                            <div class="grid_4 inner_metric">
                                <div class="metric_title">Top Engaging Products</div>
                                <table class="metric_content" id="top_engaging_products"></table>

                                <div class="no_data" data-metric="top_engaging_products">
                                    <p>No engaged products yet.</p>
                                </div>
                            </div>

                            <div class="grid_4 inner_metric">
                                <div class="metric_title">Top Engaging Content &amp; Videos</div>

                                <div class="grid_2 inner_metric">
                                    <table class="metric_content" id="top_engaged_content"></table>

                                    <div class="no_data" data-metric="top_engaged_content">
                                        <p>No results.</p>
                                    </div>
                                </div>

                                <div class="grid_2 inner_metric" style="margin-left: 20px">
                                    <table class="metric_content" id="top_videos"></table>

                                    <div class="no_data" data-metric="top_videos">
                                        <p>No results.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="grid_3 data_metric round shadow">
                            <div class="metric_title">Interaction Types</div>
                            <div id="interaction_types"></div>

                            <div class="no_data" data-metric="interaction_types">
                                <p>No engaged products yet.</p>
                            </div>
                        </div>

                        <div class="grid_3 data_metric round shadow">
                            <div class="metric_title">Interaction Sources</div>
                            <div id="interaction_sources"></div>

                            <div class="no_data" data-metric="interaction_sources">
                                <p>No interactions yet.</p>
                            </div>
                        </div>
                    {% elif category.name == "Sharing" %}
                        <div class="grid_5 data_metric round shadow">
                            <div class="metric_title">Top Shared Products</div>
                            <div class="metric_content" id="top_shared_products"></div>

                            <div class="no_data" data-metric="top_shared_products">
                                <p>Could not be determined.</p>
                            </div>
                        </div>

                        <div class="grid_5 data_metric round shadow">
                            <div class="metric_title">Share Destinations</div>
                            <div id="share_destinations"></div>

                            <div class="no_data" data-metric="share_destinations">
                                <p>Could not be determined.</p>
                            </div>
                        </div>

                        <div class="grid_5 data_metric round shadow">
                            <div class="metric_title">Sources of Shares</div>
                            <div id="sources_of_shares"></div>

                            <div class="no_data" data-metric="sources_of_shares">
                                <p>Could not be determined.</p>
                            </div>
                        </div>
                    {% elif category.name == "Awareness" %}
                        <div class="grid_3 data_metric round shadow">
                            <div class="metric_title">Visitors</div>
                            <div class="metric_content" id="total_visitors"></div>

                            <div class="no_data" data-metric="total_visitors">
                                <p>No visitors yet.</p>
                            </div>
                        </div>

                        <div class="grid_2 data_metric round shadow">
                            <div class="metric_title">Pageviews</div>
                            <div class="metric_content" id="total_pageviews"></div>

                            <div class="no_data" data-metric="total_pageviews">
                                <p>No visitors yet.</p>
                            </div>
                        </div>

                        <div class="grid_2 data_metric round shadow">
                            <div class="metric_title">Bounce Rate</div>
                            <div class="metric_content" id="bounce_rate"></div>

                            <div class="no_data" data-metric="bounce_rate">
                                <p>No data yet.</p>
                            </div>
                        </div>

                        <div class="grid_8 data_metric round shadow">
                            <div class="metric_title">Visitors over Time</div>

                            <div id="visitors_over_time"></div>

                            <div class="no_data" data-metric="visitors_over_time">
                                <p>No visitors yet.</p>
                            </div>
                        </div>

                        <div class="clear"></div>

                        <div class="grid_8 data_metric round shadow">
                            <div class="metric_title">Visitor Sources</div>
                            <div id="visitor_sources"></div>

                            <div class="no_data" data-metric="visitor_sources">
                                <p>No visitors yet.</p>
                            </div>
                        </div>

                        <div class="grid_8 data_metric round shadow">
                            <div class="metric_title">Visits by Location</div>
                            <div id="visitor_locations"></div>

                            <div class="no_data" data-metric="visitor_locations">
                                <p>No visitors yet.</p>
                            </div>
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    </div>
{% endblock %}
