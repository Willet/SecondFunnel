{% extends "pinpoint/admin_base.html" %}
{% load staticfiles %}
{% load analytics_ui %}

{% block title %}
    Analytics
{% endblock %}

{% block page_title %}
    Analytics
{% endblock %}

{% block extra_head %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static "analytics/css/analytics_style.css" %}">
    <link rel="stylesheet" href="{% static "css/jquery-ui.css" %}">

    <style>
        .top_analytics_menu {
            background-color: #fff;
            padding: 20px 0 0 20px;
            margin: 0;
            height: 50px;
            width: 920px;

            box-shadow: 0px 0px 5px #888;
        }

        .page_selector {
            display: inline;
        }

        .page_selector, .page_selector select {
            font-size: 18px;
        }

        .range_selector {
            display: inline;
            margin-left: 20px;
        }

        .range_selector input {
            font-size: 12px;
            padding: 3px;
            width: 80px;
        }

        .range_pair {
            margin-left: 15px;
        }

        .section_content {
            margin-left: 0;
        }

        .section_overview {
            border-right: 1px solid #d6d6d6;
            border-bottom: 1px solid #d6d6d6;
            margin-left: 0;
        }

        .section_overview_block {
            padding: 10px;
            border-top: 1px solid #d6d6d6;
        }

        .section_overview_block.selected, .section_overview_block:hover {
            background-color: #fff;
            cursor: pointer;
        }

        .section_overview_title {
            font-size: 18px;
        }

        .section_overview_metrics {
            font-size: 14px;
        }

        .section_overview_metrics ul {
            list-style: none;
        }

        .metric_overview {
            font-weight: bold;
        }

        .section_data {
            padding-top: 10px;
        }

        .data_title {
            font-size: 24px;
        }

        .section_footer {
            margin-top: 50px;
        }

        .section_meta {
            float: right;
            color: #b3b3b3;
        }

        .data_metric {
            margin-top: 20px;
            margin-bottom: 40px;
        }

        .metric_title, .daily_title {
            font-size: 16px;
        }

        .daily_title {
            margin-top: 15px;
        }

        .metric_title_all {

        }

        .metric_graph {

        }
    </style>
{% endblock %}

{% block extra_js_includes %}
    <script src="{% static "js/jquery-ui.js" %}"></script>
{% endblock %}

{% block top_section %}
    <nav class="grid_3 prefix_9">
        <ul>
            {% if store %}
                <li><a href="{% url store-admin store.id %}">Pages</a></li>
                <li class="selected"><a href="{% url analytics-store-admin store.id %}">Analytics</a></li>
            {% else %}
                <li><a href="{% url store-admin campaign.store.id %}">Pages</a></li>
                <li class="selected"><a href="#">Analytics</a></li>
            {% endif %}
        </ul>
    </nav>
{% endblock %}

{% block document_ready %}
    var store_id = '{{ store.id }}';
    {% if campaign %}
        var campaign_id = '{{ campaign.id }}';
    {% endif %}

    google.setOnLoadCallback(function () {
    });

    $( "#start_range" ).datepicker({
        defaultDate: "+1w",
        changeMonth: true,
        numberOfMonths: 3,
        onClose: function( selectedDate ) {
            $( "#end_range" ).datepicker( "option", "minDate", selectedDate );
        }
    });
    $( "#start_range" ).datepicker("setDate", "-2w");

    $( "#end_range" ).datepicker({
        defaultDate: "+1w",
        changeMonth: true,
        numberOfMonths: 3,
        onClose: function( selectedDate ) {
            $( "#start_range" ).datepicker( "option", "maxDate", selectedDate );
        }
    });
    $("#end_range").datepicker("setDate", new Date());

    $("#start_range, #end_range").change(function() {
        init_data();
    });

    $(".loading").ajaxStart(function() {
        $(this).show();
    });

    $(".loading").ajaxStop(function() {
        $(this).hide();
    });

    $(".section_overview_block").click(function() {
        $(".data_category").hide();
        $("div[data-cid='" + $(this).data("cid") + "']").show();

        $(".section_overview_block").removeClass("selected");
        $(this).addClass("selected");
    });

    function request_data(request) {
        start_date = $("#start_range").datepicker("getDate");
        end_date = $("#end_range").datepicker("getDate");

        request['start_date'] = start_date.getFullYear() + "/" + (start_date.getMonth() + 1) + "/" + start_date.getDate();
        request['end_date'] = end_date.getFullYear() + "/" + (end_date.getMonth() + 1) + "/" + end_date.getDate();

        update_data(request);
    }

    function update_data(o) {
        $.ajax({
            url: "{% url ajax-analytics-pinpoint %}",
            dataType: "json",
            data: o,
            success: function (data) {
                inject_analytics_data(data);
            }
        });
    }

    $("#campaign_list").change(function() {
        var campaign_id = $(this).find("option:selected").attr("value");
        init_data({'campaign_id': campaign_id});
    });

    function init_data(o) {
        var cid = o ? o.campaign_id || campaign_id : campaign_id;

        if (cid) {
            request_data({'campaign_id': cid});
        } else {
            request_data({'store_id': store_id});
        }
    }

    init_data();

{% endblock %}

{% block content %}
    <div class="top_analytics_menu">
        <div class="page_selector">
            <label for="campaign_list">Page:</label>
            <select id="campaign_list" name="campaign_list">
                <!-- <option value="overview" {% if is_overview %}selected{% endif %}>Overview</option> -->
                {% for c in store.campaign_set.all %}
                    <option value="{{ c.id }}" {% if c.id == campaign.id %}selected{% endif %}>{{ c.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="range_selector">
            <span class="range_pair">
                <label for="start_range">Start:</label>
                <input type="text" id="start_range" name="start_range">
            </span>

            <span class="range_pair">
                <label for="end_range">End:</label>
                <input type="text" id="end_range" name="end_range">
            </span>

            <span class="loading" style="display:none;">
                Loading...
            </span>
        </div>
    </div>

    <div class="grid_12 section_content">
        <div class="grid_3 section_overview">
            <div class="section_overview_block selected" data-cid="overview">
                <div class="section_overview_title">
                    Overview
                </div>
            </div>
            {% for category in categories %}
                <div class="section_overview_block" data-cid="{{ category.id }}">
                    <div class="section_overview_title">
                        {{ category.name }}
                    </div>

                    <div class="section_overview_metrics">
                        <ul>
                        {% for metric in category.enabled_metrics.all %}
                            <li>
                                <span class="metric_overview" data-metric="{{ metric.slug }}"></span>
                                {{ metric.name }}
                            </li>
                        {% endfor %}
                        </ul>
                    </div>
                </div>
            {% endfor %}
        </div>

        <div class="grid_8 section_data">
            <div class="data_category" data-cid="overview">
                <div class="data_title">
                    Overview
                </div>

                <div class="data_metrics">
                    <ul>
                        <li>Some analytics overview</li>
                    </ul>
                </div>
            </div>

            {% for category in categories %}
                <div class="data_category" data-cid="{{ category.id }}" style="display: none">
                    <div class="data_title">
                        {{ category.name }}
                    </div>

                    <div class="data_metrics">
                        {% for metric in category.enabled_metrics.all %}
                            <div class="data_metric">
                                <div class="metric_title" data-metric="{{ metric.slug }}">
                                    {{ metric.name }}:
                                    <span class="metric_title_all" data-metric="{{ metric.slug }}">0</span> total
                                </div>

                                <div class="metric_graph" id="chart_{{ metric.slug }}"></div>

                                <div class="daily_title">Daily breakdown:</div>
                                <div class="metric_daily" id="table_{{ metric.slug }}"></div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    <div class="grid_11 section_footer">
        <div class="section_meta">Last updated: {% if last_updated %}{{ last_updated }}{% else %}never{% endif %}</div>
    </div>

    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript">
        var charts_data = {},
            charts = {},
            tables_data = {},
            tables = {};

        function set_percentage(id, perc) {
            $("#" + id).html(perc.toFixed(2) + "%");
        }

        function inject_analytics_data(data) {
            for (metric_slug in charts) {
                console.log('cleared chart', metric_slug);
                charts[metric_slug].clearChart();
            }

            for (metric_slug in charts_data) {
                console.log('cleared data', metric_slug);
                charts_data[metric_slug] = [];
            }

            for (cat_slug in data) {
                for (metric_slug in data[cat_slug]) {
                    // display totals in the sidebar on in the content section
                    $(".metric_overview[data-metric='" + metric_slug + "']").html(
                        data[cat_slug][metric_slug]['totals']['all']
                    );

                    $(".metric_title_all[data-metric='" + metric_slug + "']").html(
                        data[cat_slug][metric_slug]['totals']['all']
                    );

                    // render daily breakdown
                    var this_data = new google.visualization.DataTable();
                    this_data.addColumn('date', 'Date');
                    this_data.addColumn('number', 'Product');
                    this_data.addColumn('string', 'Meta');
                    this_data.addColumn('number', data[cat_slug][metric_slug]['name']);

                    for (i in data[cat_slug][metric_slug]['data']) {
                        this_data.addRow([
                            new Date(data[cat_slug][metric_slug]['data'][i]['date'].split("-")[0],

                                // month is zero-based
                                data[cat_slug][metric_slug]['data'][i]['date'].split("-")[1] - 1,

                                data[cat_slug][metric_slug]['data'][i]['date'].split("-")[2]
                            ),
                            data[cat_slug][metric_slug]['data'][i]['product_id'],
                            data[cat_slug][metric_slug]['data'][i]['meta'],
                            data[cat_slug][metric_slug]['data'][i]['value']
                        ]);
                    }

                    if (!(metric_slug in tables)) {
                        tables[metric_slug] = new google.visualization.Table(document.getElementById('table_' + metric_slug));
                    }

                    tables[metric_slug].draw(this_data, {showRowNumber: false});


                    // render charts
                    var this_data = new google.visualization.DataTable();
                    this_data.addColumn('date', 'Date');
                    this_data.addColumn('number', data[cat_slug][metric_slug]['name']);

                    for (date in data[cat_slug][metric_slug]['totals']) {
                        if (date == "all") {
                            continue;
                        }

                        console.log(date, data[cat_slug][metric_slug]['totals'][date]);

                        if (!(metric_slug in charts_data)) {
                            charts_data[metric_slug] = [];
                        }

                        charts_data[metric_slug].push(
                            [
                                new Date(date.split("-")[0],

                                    // month is zero-based
                                    date.split("-")[1] - 1,

                                    date.split("-")[2]
                                ), data[cat_slug][metric_slug]['totals'][date]
                            ]
                        );

                        this_data.addRows(charts_data[metric_slug]);
                    }

                    if (!(metric_slug in charts)) {
                        charts[metric_slug] = new google.visualization.LineChart(document.getElementById('chart_' + metric_slug));
                    }

                    charts[metric_slug].draw(this_data, {
                        'width': 670,
                        'chartArea': {
                            'left': 35,
                            'top': 10,
                            'width': '95%',
                            'height': '80%'
                        },
                        'legend': {
                            'position': 'none'
                        },
                        'hAxis': {
                            'format': 'MMM d',
                            'gridlines': {
                                'color': '#fff'
                            }
                        },
                        'vAxis': {
                            'minValue': 0
                        },
                        'pointSize': 3
                    });
                }
            }
        }

        google.load("visualization", "1", {packages:["corechart", "table"]});
    </script>
{% endblock %}
