{% load staticfiles %}
<!-- Additional Head Contents -->
<meta http-equiv="content-type" content="text/html;charset=utf-8" />
{% for sheet in stylesheets %}
    <link rel="stylesheet" type="text/css" href="{{ sheet }}" />
{% endfor %}
<link rel="stylesheet" href="{% static "pinpoint/css/pinpoint.css" %}">
<script src="{% static "js/jquery-1.8.1.min.js" %}"></script>
<script src="{% static "js/infinity.min.js" %}"></script>

<script type="text/javascript">
    var _pptimeout, pinpointTracking = (function ($, window, document) {
        var referrerName = function () {
                    var host;

                    if (document.referrer === "") {
                        return "noref";
                    }

                    host = parseUri(document.referrer).host;
                    // want top level domain name (i.e. tumblr.com, not site.tumblr.com)
                    host = host.split(".").slice(host.split(".").length - 2, host.split(".").length).join(".");

                    if (host === "") {
                        return "noref";
                    }

                    return host;
                },

                trackEvent = function (o) {
                    var category = "pinpoint|" + referrerName(), uri;

                    uri = parseUri(window.location.href);
                    category += "|" + parseUri(uri.queryKey.url).host;

                    //console.log(['_trackEvent', category, o.action, o.label, o.value || undefined]);
                    // _gaq.push(['_trackEvent', category, o.action, o.label, o.value || undefined]);
                },

                registerShare = function (o) {
                    var action, url;
                    //console.log(pinpointTracking.socialShareType, pinpointTracking.socialShareUrl);

                    trackEvent({
                        "action": "share|" + o.network + "|" + o.type + "|" + pinpointTracking.socialShareType,
                        "label": pinpointTracking.socialShareUrl
                    });
                },

                setSocialShareVars = function (o) {
                    //console.log(o);

                    if (o['default'] === true) {
                        pinpointTracking.socialShareUrl = $("#featured_img").data("url");
                        pinpointTracking.socialShareType = "featured";
                    } else {
                        pinpointTracking.socialShareUrl = o.url;
                        pinpointTracking.socialShareType = o.sType;
                    }
                },

                clearTimeout = function () {
                    if (typeof _pptimeout == "number") {
                        window.clearTimeout(_pptimeout);
                        delete _pptimeout;
                    }
                },

                init = function() {
                    // load scripts
                    $.getScript("//platform.twitter.com/widgets.js", twitterEvents);
                    var twttr = undefined;
                    //window.twttr = (function (d,s,id) {
                    //    var t, js, fjs = d.getElementsByTagName(s)[0];
                    //    if (d.getElementById(id)) return; js=d.createElement(s); js.id=id; js.async=true;
                    //    js.src="//platform.twitter.com/widgets.js"; js.onload="pinpointTracking.registerTwitterListeners"; fjs.parentNode.insertBefore(js, fjs);
                    //    return window.twttr || (t = { _e: [], ready: function(f){ t._e.push(f) } });
                    //}(document, "script", "twitter-wjs"));

                    var twitterEvents = function(t) {
                        twttr = t;
                        twttr.events.bind('tweet', function(event) {
                            pinpointTracking.registerShare({
                                "network": "Twitter",
                                "type": "shared"
                            });
                        });

                        twttr.events.bind('click', function(event) {
                            var sType;
                            if (event.region == "tweet") {
                                sType = "clicked";
                            } else if (event.region == "tweetcount") {
                                sType = "leftFor";
                            } else {
                                sType = event.region;
                            }
                            pinpointTracking.registerShare({
                                "network": "Twitter",
                                "type": sType
                            });
                        });
                    }
                },


        // parseUri 1.2.2
        // (c) Steven Levithan <stevenlevithan.com>
        // MIT License

                parseUri = function (str) {
                    var o   = parseUri.options,
                            m   = o.parser[o.strictMode ? "strict" : "loose"].exec(str),
                            uri = {},
                            i   = 14;

                    while (i--) uri[o.key[i]] = m[i] || "";

                    uri[o.q.name] = {};
                    uri[o.key[12]].replace(o.q.parser, function ($0, $1, $2) {
                        if ($1) uri[o.q.name][$1] = $2;
                    });

                    return uri;
                };

        parseUri.options = {
            strictMode: false,
            key: ["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],
            q:   {
                name:   "queryKey",
                parser: /(?:^|&)([^&=]*)=?([^&]*)/g
            },
            parser: {
                strict: /^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,
                loose:  /^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/
            }
        };

        this.socialShareType = undefined;
        this.socialShareUrl = undefined;

        return {
            "init": init,
            "registerShare": registerShare,
            "trackEvent": trackEvent,
            "setSocialShareVars": setSocialShareVars,
            "clearTimeout": clearTimeout
        }

    }(jQuery, window, document));

    pinpointTracking.init();

</script>

<script type="text/javascript" charset="utf-8">
    var _gaq = _gaq || [];

    _gaq.push(['_setAccount', 'UA-35018502-1']);
    _gaq.push(['_trackPageview']);

    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
</script>