{% extends "pinpoint/admin_base.html" %}
{% load staticfiles %}
{% load humanize %}
{% load i18n %}
{% load base62 %}

{% block page_title %}
    {{ store }}
{% endblock %}

{% block extra_head %}
    <style xmlns="http://www.w3.org/1999/html">
        .container_12 .prefix_9, .container_16 .prefix_12 {
            padding-left: 620px;
            width: 310px;
        }

        .content_block img {
            max-height: 150px;
            max-width: 150px;
        }

        .content_block {
            float: left;
            border: 2px solid #999;
            width: 200px;
            margin-right: 15px;
        }

        .content_block:hover {
            border: 2px #a00 solid;
        }

        .content_block.selected {
            border: 2px #f00 solid;
        }

        .content_block.selected:hover {
            border: 2px #f00 dotted;
        }

        .clear {
            clear: both;
        }
    </style>
{% endblock %}

{% block extra_js_includes %}
    <script src="{% static "js/jquery-ui.js" %}"></script>
{% endblock %}

{% block document_ready %}
    var store_id = 21; //{{ store_id }}

    $('#tag').autocomplete({
        source: function(request, response) {
            var term = request.term;
            $.getJSON('/api/assets/v1/product/', {
                'store': store_id,
                'format': 'json',
                'name_or_url': term

            }, function(data) {
                //convert object to usable form
                var results = [];
                $.each(data.objects, function(index, value) {
                    results.push({'label': value.name, 'id': value.id})
                });
                response(results);
            })
        },
        minLength: 2,
        select: function( event, ui ) {
            if (ui.item) {
                $('#product_id').val(ui.item.id);
            }
        }
    });

    $('.content_block').on('click', function(e) {
        $(this).toggleClass('selected');

        if($('.content_block.selected').length > 0) {
            $('#tag_button').removeClass('disabled');
        } else {
            $('#tag_button').addClass('disabled');
        }
    });

    $('#tag_button').on('click', function (e) {
        var data = [];
        e.preventDefault();

        $('.content_block.selected').each(function(index, item) {
            data.push($(item).data());
        });

        $('#instagram').val(JSON.stringify(data));

        $(this).parents('form').submit();
    });
{% endblock %}

{% block top_section %}
    <div class="grid_3 prefix_9">
        <ul>
            <li><a href="{% url store-admin store.id %}">Pages</a></li>
            <li class="selected"><a href="{% url asset-manager store.id %}">Asset Manager</a></li>
            <li><a href="{% url analytics-store-admin store.id %}">Analytics</a></li>
        </ul>
    </div>
{% endblock %}

{% block content %}
    {# User facing code, for now #}
    <p>
    {% if instagram_connect_request %}
    Not currently connected to instagram.
        <a href='{% url socialauth_associate_begin 'instagram' %}'>Connect?</a>
    {% else %}
    Connected to Instagram
    {% endif %}
    </p>

    {# Internal code, for now #}
    {% if request.user.is_superuser %}
        <form action='{% url tag-content store_id %}' method='POST'>
            <p>I am a robot. Beep boop.</p>

            {% for content in contents %}
                <div class='content_block instagram'
                    data-original-id='{{ content.original_id }}'
                    data-image-url='{{ content.image_url }}'
                    data-type='{{ content.type }}'
                    data-text-content='{{ content.text_content|escape }}'>
                    <img src='{{ content.image_url }}'/>
                    <span class='text'>{{ content.text_content }}</span>
                </div>
            {% endfor %}

            <br class='clear'/>
            <p>
                <label>Tag with:<input type='text' id='tag'/></label>
            </p>
            <input type='hidden' id='product_id' name='product_id' value='-1' />
            <input type='hidden' id='instagram' name='instagram' value='' />
            {% csrf_token %}
            <a id="tag_button" class="button disabled" href="#">
                Tag Content
            </a>
        </form>
    {% endif %}
{% endblock %}
