{% load staticfiles %}
<script src="{% static "js/underscore.js" %}"></script>
<script src="{% static "js/jquery-1.8.1.min.js" %}"></script>
<script src="{% static "js/jquery.viewport.js" %}"></script>
<script src="{% static "js/jquery.masonry.min.js" %}"></script>
<script src="{% static "js/jquery.imagesloaded.min.js" %}"></script>

<script type="text/javascript">
    (function() {
        window.PINPOINT_INFO = {
            'page': {
                'pubDate': '{{ pub_date }}',  // for verifying the original upload date of a static campaign. for human use only
                'id': '{{ campaign.intentrank.id|default:campaign.id }}',
                'main-block-template': '{{ campaign.template }}',
                'stl-image': '{{ campaign.stl_image }}',
                'featured-image': '{{ campaign.featured_image }}',
                'description': '{{ campaign.description|escapejs }}',
                'product': {{ product.json|safe }}
            },
            'store': {
                'id': '{{ campaign.store.slug }}',
                'name': '{{ campaign.store.name }}'
            },
            'content': [],
            'campaign': {
                'id': '{{ campaign.id }}'
            },
            'featured': {% include "pinpoint/snippets/product_object.js" with product=product featured=True only %}
            {% if backup_results %}{# offline, pseudo-custom results #}
            , 'backupResults': {{ backup_results|safe }}
            {% endif %}
            {% if random_results %}{# offline, totally random results #}
            , 'randomResults': {{ random_results|safe }}
            {% endif %}
        };

        $.Mason.prototype._placeBrick = function( brick ) {
            var $brick = $(brick),
                    colSpan, groupCount, groupY, groupColY, j,
                    dupes, instagramImg;

            // START WILLET
            this.recent = this.recent || [];

            // Check to see if we've recently included this instagram
            // image. If so, skip it.
            if ($brick.hasClass('instagram')) {
                instagramImg = $brick.find('img').not('.social-buttons ' +
                        'img').prop('src');
                dupes = _.filter(this.recent, function($elem) {
                    var elemImg = $elem.find('img').not('.social-buttons ' +
                            'img').prop('src');
                    return (elemImg == instagramImg);
                });

                if (dupes.length != 0) {
                    this.remove($brick);
                    return;
                }
            }

            while(this.recent.length > 5) {
                this.recent.shift();
            }
            this.recent.push($brick);
            // END WILLET

            //how many columns does this brick span
            colSpan = Math.ceil( $brick.outerWidth(true) / this.columnWidth );
            colSpan = Math.min( colSpan, this.cols );

            if ( colSpan === 1 ) {
                // if brick spans only one column, just like singleMode
                groupY = this.colYs;
            } else {
                // brick spans more than one column
                // how many different places could this brick fit horizontally
                groupCount = this.cols + 1 - colSpan;
                groupY = [];

                // for each group potential horizontal position
                for ( j=0; j < groupCount; j++ ) {
                    // make an array of colY values for that one group
                    groupColY = this.colYs.slice( j, j+colSpan );
                    // and get the max value of the array
                    groupY[j] = Math.max.apply( Math, groupColY );
                }

            }

            // BEGIN WILLET
            /*
             *   We need to ensure that the short column is NOT an odd numbered
             *   column, so, we may need to find the second shortest column
             * */
            // get the minimum Y value from the columns
            var dupeGroupY = groupY.slice(0);
            var minYObjs = []
            for (var k=0; k < dupeGroupY.length; k++) {
                minYObjs.push({
                    'column': k,
                    'value': dupeGroupY[k]
                });
            }

            minYObjs.sort(function(a,b) {
                if (a.value !== b.value) {
                    return a.value - b.value;
                } else {
                    return a.column - b.column;
                }
            });

            var minimumY = Math.min.apply( Math, groupY ),
                    shortCol = 0;

            // Iterate over all the minimums...
            for (var l= 0, len = minYObjs.length; l < len; l++) {
                var item = minYObjs[l];
                shortCol = item.column;
                minimumY = item.value;

                if ($brick.hasClass('youtube') && (shortCol % 2 != 0)) {
                    continue;
                } else {
                    break;
                }
            }

            // Find index of short column, the first from the left
            /*for (var i=0, len = groupY.length; i < len; i++) {
             if ( groupY[i] === minimumY ) {
             shortCol = i;
             break;
             }
             }*/
            // END WILLET

            // position the brick
            var position = {
                top: minimumY + this.offset.y
            };

            // position.left or position.right
            position[ this.horizontalDirection ] = this.columnWidth * shortCol + this.offset.x;
            this.styleQueue.push({ $el: $brick, style: position });

            // apply setHeight to necessary columns
            var setHeight = minimumY + $brick.outerHeight(true),
                    setSpan = this.cols + 1 - len;
            for ( i=0; i < setSpan; i++ ) {
                this.colYs[ shortCol + i ] = setHeight;
            }
        }
    })();
</script>

<script src="{% static "pinpoint/js/utils.js" %}"></script>
<script src="{% static "pinpoint/js/tracking.js" %}"></script>
<script src="{% static "pinpoint/js/pinpoint.js" %}"></script>

<script type="text/javascript">
    // Load Youtube IFrame Player API code asynchronously
    var tag = document.createElement('script');
    tag.src = "//www.youtube.com/iframe_api";

    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    function onYouTubeIframeAPIReady() {
        PINPOINT.init();
    }
</script>

<script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', '{{ ga_account_number }}']);

    _gaq.push(['_setCustomVar',
        1,                          // slot id
        'StoreID',                  // name
        '{{ campaign.store.id }}',  // value
        3                           // scope: page-level
    ]);

    _gaq.push(['_setCustomVar',
        2,
        'CampaignID',
        '{{ campaign.id }}',
        3
    ]);

    _gaq.push(['_trackPageview']);

    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
</script>