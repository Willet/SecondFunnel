{% load staticfiles %}
{% load i18n %}
{% load pinpoint_ui %}

<html>
<head>
    <link rel="stylesheet" href="{% static "css/960.css" %}">
    <link rel="stylesheet" href="{% static "css/reset.css" %}">
    <link rel="stylesheet" href="{% static "css/text.css" %}">
    <link rel="stylesheet" href="{% static "css/smoothness/jquery-ui.css" %}">

    <link rel="shortcut icon" href="{% static "images/favicon.ico" %}" />
    <style type="text/css">
        html, body {
            margin: 0;
            padding: 0;
        }
        h2 {
            margin: 20px 0 0 0;
        }
        #preview_frame {
            width: 100%;
            height: 100%;
        }
        #overlay {
            position: fixed;
            z-index: 100;
            width: 300px;
            height: 100%;
            right: 0;
            padding: 15px;
            background: rgba(255,255,255,0.9);
            box-shadow: 0 0 15px #222;
            overflow: auto;
        }
        #overlay textarea {
            width: 280px;
        }
        #themer {
            padding-bottom: 30px;
        }
    </style>
    <script type="text/javascript"
            src="//ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
</head>
<body>
    <div id="overlay">
        <h1>Edit Theme</h1>
        <p>Here, you can edit styles for your theme.</p>
        <form id="themer" action="" method="POST">
            {% csrf_token %}
            <h2>Featured product area</h2>
            <textarea data-target=".cell" cols="30" rows="5"
                placeholder="Enter styles here"></textarea>

            <h2>Shop-the-look area</h2>
            <textarea data-target=".lifestyle.cell" cols="30" rows="5"
                placeholder="Enter styles here"></textarea>

            <h2>Generic block</h2>
            <textarea data-target=".block" cols="30" rows="5"
                placeholder="Enter styles here"></textarea>

            <h2>Product block</h2>
            <textarea data-target=".product.block" cols="30" rows="5"
                placeholder="Enter styles here"></textarea>

            <h2>Featured product area</h2>
            <textarea data-target=".featured.product" cols="30" rows="5"
                placeholder="Enter styles here"></textarea>

            <h2>Preview area</h2>
            <textarea data-target=".preview" cols="30" rows="5"
                placeholder="Enter styles here"></textarea>

            <h2>Instagram preview area</h2>
            <textarea data-target=".preview.container .content .instagram" cols="30" rows="5"
                placeholder="Enter styles here"></textarea>

            <input id="submit" class="button submit focus"
                   type="submit" value="Save theme" />
        </form>
    </div>
    <iframe id="preview_frame" src="/pinpoint/admin/120/theme/1/preview"
            frameborder="0"></iframe>
    <script type="text/javascript">
        $(document).ready(function () {
            var page, pageFrame = $('#preview_frame'), pageWindow, pageQuery;

            var highlight = function (selector) {
                if (!page) return;
                unhighlight();
                setTimeout(function () {
                    pageQuery(selector).expose({
                        color: '#555',
                        loadSpeed: 200,
                        closeSpeed: 200
                });
                }, 300);
            };

            var unhighlight = function () {
                if (!page) return;
                pageQuery.mask.close();  // this call is non-blocking.
            };

            var injectScript = function (url) {
                if (!page) return;
                var script = document.createElement('script');
                script.type = 'text/javascript';
                script.src = url;
                page.find('head').append(script);
            };

            var compileSelectorStyles = function (selector, styleMap) {
                // generate a string for the selector {prop:style} map.
                var styleName, ssBuffer = selector + '{';
                for (styleName in styleMap) {
                    if (styleMap.hasOwnProperty(styleName)) {
                        ssBuffer = ssBuffer + styleName + ':' +
                                styleMap[styleName] + ';';
                    }
                }
                return ssBuffer;
            };

            var applyStyles = function (computedCSS) {
                // adds the css into the target page.
                if (!page) return;
                var injectLocation = pageQuery('#style_inject_target');
                if (!injectLocation.length) {
                    // make one up
                    pageQuery('body').append(pageQuery('<' +
                        'style id="#style_inject_target"><' + '/style>'));
                    injectLocation = pageQuery('#style_inject_target');
                }
                injectLocation.html(computedCSS);  // override previous
            };

            pageFrame.load(function (){
                // create convenience variables
                page = pageFrame.contents();
                pageWindow = $(pageFrame[0].contentWindow);
                pageQuery = $(pageWindow)[0].$;

                $('#themer textarea')
                    .mouseenter(function (that) {
                        highlight($.trim($(that.target).data('target')));
                    })
                    .mouseleave(unhighlight)
                    .keyup(function (ev) {
                        // export newly entered css to the bottom of the page.
                        // it does not validate, because
                        // http://stackoverflow.com/questions/4803518
                        $theElement = $(ev.target);
                        var combinedStyles = '';
                        $('textarea').map(function (idx, obj) {
                            combinedStyles += $(obj).data('target') +
                                    ' {' + $(obj).val() + '}';
                        });
                        applyStyles(combinedStyles);
                    });

                $('#themer #submit').click(function (e) {
                    e.preventDefault();
                });
            });
        });
    </script>
</body>
</html>