{% extends "pinpoint/admin_base.html" %}
{% load staticfiles %}
{% load humanize %}

{% block page_title %}
    {{ store }}
{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static "css/jquery.dataTables.css" %}">
    <link rel="stylesheet" href="{% static "css/jquery.qtip.min.css" %}">
    <link rel="stylesheet" href="{% static "js/DataTables/css/demo_page.css" %}">
    <link rel="stylesheet" href="{% static "js/DataTables/css/demo_table.css" %}">

    <style>
        .online {
            color :#13b240;
        }
        .offline {
            color: #b23739;
        }

        table a, table a:visited {
            color: #4398aa;
        }

        th {
            text-align: center;
        }

        #new_page_button {
            position: absolute;
            z-index: 9001;
        }

        p {
            margin: 0;
        }

        /* table */
        #pageList {
            width:980px;
        }
        
        #pageList td {
            white-space: nowrap;
            overflow: hidden;
            margin: 0;
            padding:0;
            border-bottom: 1px solid #ccc;
            text-align: center;
        }
        
        #pageList td div {
            text-align: center;
            white-space: nowrap;
            height: 23px;
            margin:auto;
            padding: 5px 5px;
        }
        
        #pageList td div * {
            height: 100%;
            display: inline;
            text-align: center;
            vertical-align: middle;
        }
        
        #pageList tr.odd {
            background-color: transparent;
        }
        
        #pageList tr.odd td.sorting_1 {
            background-color: #fff;
        }
        
        table.display thead th {
            border-bottom: 1px solid #ccc;
        }
        
        .dataTables_scrollBody {
            height: 400px;
        }
        
        #pageList_wrapper {
            height: 435px;
            padding: 10px;
        }
        
        #pageList_info {
            display: none;
        }
        
        #pageList_wrapper input {
            padding: 2px;
        }
        
        #pageList_filter {
            position: relative;
            top: -10px;
        }

        #pageList_wrapper {
            padding-top: 20px;
        }

        /* end table */
    </style>
{% endblock %}

{% block extra_js_includes %}
    <script src="{% static "js/jquery.dataTables.min.js" %}"></script>
    <script src="{% static "js/jquery.qtip.min.js" %}"></script>
{% endblock %}

{% block document_ready %}
            jQuery.extend(jQuery.fn.dataTableExt.oSort, {
                "timestamp-numeric-pre": function ( a ) {
                    var x = a.match(/data-timestamp="*(-?[0-9\.]+)/)[1];
                    return parseFloat( x );
                },

                "timestamp-numeric-asc": function ( a, b ) {
                    return ((a < b) ? -1 : ((a > b) ? 1 : 0));
                },

                "timestamp-numeric-desc": function ( a, b ) {
                    return ((a < b) ? 1 : ((a > b) ? -1 : 0));
                }
            });

            var dataRowOptions = { sWidth: '50px', bSortable: false },
                pageListTable = $("#pageList").dataTable({
                    "bScrollInfinite": true,
                    "bScrollCollapse": true,
                    "sScrollY": "400px",
                    "bPaginate": false,
                    "fnDrawCallback": function() {
                        $("#pageList tr.even").removeClass('even').addClass('odd');
                    },
                    "bAutoWidth": false,
                    "aoColumns" : [
                        null,
                        { "sType": "timestamp-numeric"},
                        dataRowOptions,
                        dataRowOptions,
                        dataRowOptions
                    ],
                    "aaSorting": [[1, "desc"]],
                    "oLanguage": {
                        "sZeroRecords": "No pages match that search.",
                        "sEmptyTable": "Sorry, you haven't made any pages yet :("
                    }
                });

            var ajax_urls = {
                "save_as_draft": "{% url ajax-campaign-save-draft %}",
                "publish": "{% url ajax-campaign-publish %}"
            };

            $("button[data-type='ajax']").click(function (e) {
                e.preventDefault();

                $.ajax({
                    url: ajax_urls[$(this).data("action")],
                    type: "POST",
                    dataType: 'json',
                    data: {'campaign_id': $(this).data("content")},
                    success: function(data) {
                        if (data.success) {
                            window.location.href = "{% url store-admin store.id %}";
                        }
                    }
                });
            });

            $("#pageList_filter input").unbind("keyup").keyup(function() {
                pageListTable.fnFilter( this.value, 0 );
            })

            $("ul.messages li").on('click', function() {
                $(this).slideUp();
            });

            if (pageListTable.fnGetNodes().length == 0) {
                $("#new_page_button").addClass('wiggle');
            }

            $("tbody tr").qtip({
                content: {
                    text: '<input type="textbox" value="asdf"></input>',
                    title: {
						text: 'Copy Link',
						button: true
					}
                },
                position: {
                    my: "left center",
                    at: "right center"
                },
                show: {
					event: false, // Don't specify a show event...
					ready: false // ... but show the tooltip when ready
				},
                hide: true,
                events: {
                    show: function() {
                        var tooltip = $(this)
                        var input = $('input', tooltip);
                        input[0].select();
                        input.unbind('click').click(function() {
                            input[0].select();
                        });
                        input.unbind('fcousout').focusout(function() {
                            tooltip.qtip('hide');
                        });
                    }
                },
            })

            $(".get_link").click(function() {
                $('tbody tr').qtip('hide');
                var tr = $(this).closest('tr');
                tr.qtip('show');
                $("#" + tr.attr('aria-describedby') + " input")[0].select();
            });
{% endblock %}

{% block top_section %}
    <div class="grid_3 prefix_9">
        <ul>
            <li class="selected">Pages</li>
            <li>Analytics</li>
        </ul>
    </div>
{% endblock %}

{% block content %}
    <a id="new_page_button" class="button focus" href="{% url new-campaign-admin store.id %}">New Page</a>
    <table id="pageList" cellpadding="0" cellspacing="0" border="0" class="display" >
        <thead>
            <tr>
                <th>Name</th>
                <th>Date Modified</th>
                <th></th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for campaign in store.campaign_set.all %}
            {% if campaign.live %}
            <tr>
                <td><div><a href="
                {% url edit-campaign-admin campaign.store.id campaign.id %}"
                        >{{ campaign.name }}</a></div></td>
                <td><div data-timestamp='{{ campaign.last_modified|date:"U" }}'>{{ campaign.last_modified|naturalday }}</div></td>
                <td><div><a class="get_link" href="#">Get Link</a></div></td>
                <td><div><a href="{% url analytics-campaign-admin campaign.id %}">Analytics</a></div></td>
                <td><div><a href="{% url campaign campaign.id %}" target="_blank">View Page</a></div></td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>
{% endblock %}
