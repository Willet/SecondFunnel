{% load staticfiles %}
<html>
    <head>
        <style type='text/css'>
            body {
                font-family: 'Helvetica Neue', 'Arial Narrow', sans-serif;
            }

            h1, h2, h3, h4, h5 {
                clear: both;
            }

            .tile {
                width: 250px;
                height: 250px;
                float: left;
                margin: 5px;
                position: relative;
                overflow: hidden;
                border-radius: 10px;
            }

            .tile > .count {
                position: absolute;
                top: 0px;
                right: 0px;
                width: 25px;
                height: 25px;
                background: rgba(255,255,255, 0.5);
                text-align: center;
                line-height: 25px;
                font-size: 18px;
                font-weight: bold;
                border-radius: 10px;
                margin-right: 10px;
                margin-top: 10px;
            }

            .tile > .data {
                position: absolute;
                bottom: 0px;
                background: rgba(255,255,255, 0.5);
                border-radius: 10px;
                margin: 10px;
                width: 220px;
                padding: 5px;
            }

            .tile .product {
                font-size: 12px;
                font-weight: bold;
            }

            .tile .id {
                float: right;
                font-size: 12px;
                font-style: italic;
            }

            .tile img {
                max-width: 99%;
            }
        </style>
        <script type='text/javascript'
                src='{% static 'js/jquery.min.js' %}'></script>
        <script type='text/javascript'
                src='{% static 'js/underscore.js' %}'></script>
    </head>
    <body>
        <h1>Statistics</h1>
        <h2>Tiles by preview count</h2>
        <div id='tiles'></div>

        <h2>Tiles by impression count</h2>
        <div id='impressions'></div>
        <script type='text/template' id='tile-template'>
            <div class='tile'>
                <div class='count'>
                    <%= count %>
                </div>
                <img src='<%= imageUrl %>' />
                <div class='data'>
                    <span class='product'><%= product %></span>
                    <span class='id'>(<a href='<%= url %>'><%= tileId %></a>)
                    </span>
                </div>
            </div>
        </script>
        <script type="text/javascript">
            var Keen=Keen||{configure:function(e){this._cf=e},addEvent:function(e,t,n,i){this._eq=this._eq||[],this._eq.push([e,t,n,i])},setGlobalProperties:function(e){this._gp=e},onChartsReady:function(e){this._ocrq=this._ocrq||[],this._ocrq.push(e)}};(function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src=("https:"==document.location.protocol?"https://":"http://")+"dc8na2hxrj29i.cloudfront.net/code/keen-2.1.0-min.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})();

            // Configure the Keen object with your Project ID and (optional) access keys.
            Keen.configure({
                projectId: "532745f6ce5e4326bf000011",
                readKey: "c8ff6b6ec8efb33e85fbcade3d9ecbe102dbb884c586ab4cf7b14e0014effdc911e819b6ba9cb7517c3fbe26a5cf2812ff9cafe29b9d073e8a50928cf27f85b5845c7ba3c304d8b7dc346200dce3eecfe13d541c6bcddbdc3f70c6213a4f18f5c66de9f22ae62b1e107cc27252314db8"
            });
        </script>
        <script type='text/javascript'>
            var tileTemplate = _.template($('#tile-template').text())

            var addTiles = function(response, selector) {
                if (!selector) {
                    selector = '#tiles';
                }

                var data = response.result;
                data = _.sortBy(data, function(item) {
                    return -1 * item.result;
                });

                $.each(data, function(idx, obj) {
                    var data = {
                        'count': obj.result,
                        'imageUrl': obj['tile.url'],
                        'product': obj['product.name'],
                        'tileId': obj['tile.id'],
                        'url': obj['page.url'] + '#' + obj['tile.id']
                    }

                    $(selector).append(tileTemplate(data))
                })
            }

            // https://keen.io/docs/clients/javascript/usage-guide/#analyze-and-visualize-data
            Keen.onChartsReady(function() {
                var previewQuery = new Keen.Metric('preview', {
                    'analysisType': 'count',
                    'groupBy': [
                        'page.url',
                        'tile.url',
                        'tile.id',
                        'product.name'
                    ],
                    'filters': [{
                        'property_name': 'page.id',
                        'operator': 'eq',
                        'property_value': {{ page.id }}
                    }]
                });

                var impressions = new Keen.Metric('impression', {
                    'analysisType': 'count',
                    'groupBy': [
                        'page.url',
                        'tile.url',
                        'tile.id',
                        'product.name'
                    ],
                    'filters': [{
                        'property_name': 'page.id',
                        'operator': 'eq',
                        'property_value': {{ page.id }}
                    }]
                });

                previewQuery.getResponse(function(response) {
                    addTiles(response, '#tiles');
                });

                impressions.getResponse(function(response) {
                    addTiles(response, '#impressions');
                });
            });
        </script>
    </body>
</html>