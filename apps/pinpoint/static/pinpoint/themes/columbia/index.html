{% load staticfiles %}
<!DOCTYPE html>
<html lang="en">
<head>
    {% include "pinpoint/campaign_opengraph_tags.html" %}
    {% include "pinpoint/campaign_head.html" %}
    <!-- End Optimizer Tests -->
    <link rel="shortcut icon"
         href="http://demandware.edgesuite.net/aacw_prd/on/demandware.static/Sites-Columbia_US-Site/-/default/v1400764540841/images/apple-icons/152.png" />
    <link rel="stylesheet"
          href="{% static 'pinpoint/themes/columbia/columbia.css' %}"/>
    {% include "pinpoint/campaign_respond.html" %}
    <!-- Add Optimizer Tests here -->
    <script type="text/javascript">
        window.TRACKING_PIXELS = {
            'A': {
                'view': 'http://cm.gy/b8p5',
                'click': 'http:/cm.gy/yoio'
            }
        };
        window.ACTIVE_TEST = 'A';
    </script>
    {% if environment == 'production' %}
        <script type='text/javascript'>
            var interval = setInterval(function() {
                var test, bindFn;

                if (!window.ACTIVE_TEST) {
                    return;
                }

                // Because we need to bind some events before anything else, use this fn
                // http://stackoverflow.com/a/2641047
                $.fn.bindFirst = function(name, fn) {
                    // bind as you normally would
                    // don't want to miss out on any jQuery magic
                    this.on(name, fn);

                    // Thanks to a comment by @Martin, adding support for
                    // namespaced events too.
                    this.each(function() {
                        var handlers = $._data(this, 'events')[name.split('.')[0]];
                        // take out the handler we just inserted from the end
                        var handler = handlers.pop();
                        // move it at the beginning
                        handlers.splice(0, 0, handler);
                    });
                };

                bindFn = function() {
                    (new Image).src = window.TRACKING_PIXELS[test].click;
                }

                clearInterval(interval);
                test = window.ACTIVE_TEST;

                // Append click pixel
                if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                    $('.tile').bindFirst('click', bindFn);
                } else {
                    // Why doesn't bindFirst work on desktop?
                    $('body').on('click', '.tile', bindFn);
                }


                // Append page view pixel
                (new Image).src = window.TRACKING_PIXELS[test].view;
            }, 1000);
        </script>
    {% endif %}
    <title>{{ page.name|default:"Columbia" }}</title>
    <style type="text/css">
        /* out of necessity */
        .visible-xs.jumbotron { /* mobile hero */
            {% if mobile_hero_image %}
                background-image: url('{{ mobile_hero_image }}');
            {% else %}
                background-image: url('{{ desktop_hero_image }}');
            {% endif %}
        }
        .visible-md.jumbotron, .visible-lg.jumbotron, .visible-sm.jumbotron { /* desktop hero */
            {% if desktop_hero_image %}
                background-image: url('{{ desktop_hero_image }}');
            {% else %}
                background-image: url('{{ mobile_hero_image }}');
            {% endif %}
        }
    </style>
</head>
<body>
    <div class='navbar'>
        <div class="container">
            <img src="{% static 'pinpoint/themes/columbia/images/logo.png' %}">
        </div>
    </div>

    {% include "pinpoint/campaign_body.html" %}

    <div>
        <!-- generic templates -->
        <script type="text/template" id="category_template">
            <span><%= obj.name %></span>
        </script>

        <script type="text/template" id="shopthelook_template">
            <div class='featured product'>
                <img class='img-responsive pull-left' src='<%= obj.defaultImage.url %>' />
                <div class='pull-right'><%= obj.title || obj.name %></div>
                    <div class='price'><%= obj.price %></div>
                    <div>
                        <a href='<%= obj.url %>' target='_blank'>BUY NOW</a>
                    </div>
                </div>
            </div>

            <div class='spacer'></div>
        </script>

        <script type="text/template" id="product_tile_template">
            <div class="tap-indicator-target"></div>
            <img class="focus" src="<%= obj.image.url %>" alt="<%= caption %>" />
            <% if (App.option('debug', 0) > 1) { %>
                <span class="type"><%= obj['content-type'] %></span>
            <% } %>
            <div class="name"><%= obj.title || obj.name %></div>
        </script>

        <script type="text/template" id="image_tile_template">
            <div class="tap-indicator-target"></div>
            <div class='relative'>
                <img class="focus" src="<%= obj.image.url %>" alt="<%= obj.caption %>" />
            </div>
            <% if (App.option("debug", 0) > 1) { %>
                <span class="type"><%= obj["content-type"] %></span>
            <% } %>
        </script>

        <script type="text/template" id="youtube_tile_template">
            <div class="img-responsive thumbnail"
                 style="background-image: url('<%= obj.thumbnail || obj.image.url %>');">
              &nbsp;
              <img src="" alt="this img tag intentionally left blank" style="visibility:hidden"/>
            </div>
            <%= obj.caption || obj.name %>
            <div class="social-buttons"></div>
        </script>

        <script type="text/template" id="preview_container_template">
            <div class="fullscreen">
                <% if (!App.support.mobile()) { %>
                    <span class="close">X</span>
                <% } %>
                <div class="content">
                    <% if (App.support.mobile()) { %>
                        <span class="close">Back to browsing</span>
                    <% } %>
                    <div class="scrollable">
                        <div class="template target"></div>
                    </div>
                </div>
            </div>
            <div class="mask"></div>
        </script>

        <script type="text/template" id="tile_preview_template">
            <h2><span class="label label-info"><%= obj.template %>_preview_template</span> is missing.</h2>
            <p>You can define one in your template.</p>
            <ul>
                <% for (i in obj) { %>
                    <li><b><%= i %></b>: <%= obj[i] %></li>
                <% } %>
            </ul>
        </script>

        <script type="text/template" id="tap_indicator_template">
            +
            <div>
                <%= App.option('tapIndicatorText', 'tap to see more') %>
            </div>
        </script>

        <script type="text/template" id="product_price_template">
            <%- obj.price %>
        </script>

        <script type="text/template" id="product_title_template">
            <%- obj.title || obj.name %>
        </script>

        <script type="text/template" id="product_buy_template">
            <a class='button' href='<%= obj.url %>' target='_blank'>
                Shop Now
            </a>
        </script>

        <script type="text/template" id="product_galleryMainImage_template">
            <div class="main-image-container">
                <% if (obj.images.length > 1) { %>
                    <div class="gallery-swipe-left"></div>
                    <div class="gallery-swipe-right"></div>
                <% } %>
                <% if (obj.image) { %>
                    <img class="main-image" src='<%= obj.image.url %>'/>
                <% } else { %>
                    <img class="main-image" src='<%= obj.images[0].url %>'/>
                <% } %>
            </div>
        </script>

        <script type="text/template" id="product_preview_template">
            <div class='content-wrapper row'>
                <% if (App.support.mobile()) { %>
                    <div class='cell info'>
                        <div class='title'></div>
                        <div class='price'></div>
                        <div class='buy'></div>
                    </div>
                <% } %>
                <div class='cell middle'>
                    <div class="gallery-main-image"></div>
                </div>
                <% if (obj.images.length > 1 && App.support.mobile()) { %>
                    <div class='cell'>
                        <div class='gallery dots'></div>
                    </div>
                <% } %>
                <% if (!App.support.mobile()) { %>
                    <div class='cell middle info'>
                        <div class='title'></div>
                        <div class='price'></div>
                        <div class='buy'></div>
                        <div class="gallery<% if (obj.images.length < 2) { %> hide<% } %>"></div>
                    </div>
                <% } %>
            </div>
        </script>

        <script type="text/template" id="image_preview_template">
            <% if (obj['tagged-products'].length) { %>
                <% var product = obj['tagged-products'][0]; %>
                <div class="image-with-tagged-products">
                    <div class="row">
                        <% if (obj['tagged-products'].length > 1) { %>
                            <div class="cell desktop-only">
                                <div class="stl-title">The Look</div>
                                <div class="stl-look">
                                    <% var  related = obj['tagged-products'] %>
                                    <% for (var i = 0; i < related.length; i++) { %>
                                        <div class="stl-item" data-index="<%- i %>">
                                            <img src="<%- related[i].images[0].url %>" />
                                            <div class="name">
                                                <%- related[i].title || related[i].name %>
                                            </div>
                                        </div>
                                    <% } %>
                                </div>
                            </div>
                        <% } %>
                        <div class="cell desktop-only">
                            <img src="<%= obj.image.url %>" alt="image" class="image"/>
                        </div>
                        <div class="middle cell info image">
                            <% if (App.support.mobile()) { %>
                                <div class='title'></div>
                                <div class='price'></div>
                                <div class='buy'></div>
                                <div class="gallery-main-image"></div>
                            <% } %>
                            <% if (!App.support.mobile()) { %>
                                <div class='title'></div>
                                <div class='price'></div>
                                <div class="gallery-main-image"></div>
                                <div class='buy'></div>
                            <% } %>
                            <div class='gallery<% if (App.support.mobile()) { %> dots<% } %><% if (obj.images.length < 2) { %> hide<% } %>'></div>
                        </div>
                        <% if (obj['tagged-products'].length > 1 && App.support.mobile()) { %>
                            <div class="more-info">
                                More from this look...
                            </div>
                        <% } %>
                        <div class="image cell mobile-only">
                            <img src="<%= obj.image.url %>" alt="image"/>
                        </div>
                        <% if (obj['tagged-products'].length > 1) { %>
                            <div class="cell mobile-only">
                                <div class="stl-title">The Look</div>
                                <div class="stl-look">
                                    <% var  related = obj['tagged-products'] %>
                                    <% for (var i = 0; i < related.length; i++) { %>
                                        <div class="stl-item" data-index="<%- i %>">
                                            <img src="<%- related[i].images[0].url %>" />
                                            <div class="name">
                                                <%- related[i].title || related[i].name %>
                                            </div>
                                        </div>
                                    <% } %>
                                </div>
                            </div>
                        <% } %>
                    </div>
                </div>
            <% } else { %>
                <div class="image-without-tagged-products">
                    <div class="row">
                        <div class="image middle cell capped-width">
                            <img src="<%= obj.image.url %>" alt="image" class="main-image" />
                        </div>
                        <div class="middle cell">
                            <div class="info">
                                <div class="title">
                                    Coming soon to Columbia!
                                </div>
                                <div class="buy">
                                    <a class='button' href='http://www.columbia.com/fishing/Collection_PFG,default,pg.html' target='_blank'>
                                        Shop On Columbia
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            <% } %>
        </script>

        <!-- custom templates -->
        <script type="text/template" id="hero_template">
            <div class="hero-image-wrapper">
                <div class="visible-xs jumbotron">
                    <img src="{{ mobile_hero_image }}" alt="Hero" />
                </div>
                <div class="visible-sm jumbotron">
                    <img src="{{ desktop_hero_image }}" alt="Hero" />
                </div>
                <div class="visible-md visible-lg jumbotron"></div>
            </div>
            {% if legal_copy %}
                <div class="legal us">
                    {{ legal_copy }}
                </div>
            {% endif %}
        </script>
    </div>

    <div class="container">
        <!-- .container is bootstrap magic, and has a viewport-dependent width. -->
        <div id="hero-area"></div>
        <div id="category-area"></div>
        <div id="discovery-area" class="discovery-area"></div>
        <div class="no-noscript loading"></div>
        <noscript>
            <!-- promotions to show when user does not have javascript.
             this is a 'we need javascript' message by default.
             -->
            <div class="alert alert-danger">
                <b>Oh no!</b> We need JavaScript enabled to show you this page.
            </div>
        </noscript>
    </div>

    <!-- GAP Google Analytics -->
    <script type="text/javascript">

        function initGapAnalytics () {
            // Shorthand for pushing data to Google Analytics
            var productName = null,
                recordEvent = function (event, eventCategory, eventAction, eventLabel) {
                    dataLayer.push({
                        'event': event,
                        'eventCategory': eventCategory,
                        'eventAction': eventAction,
                        'eventLabel': eventLabel
                    });

                    // for our internal analytics: also track these events.
                    // tracking page_scroll causes infinite loops.
                    if (event !== 'page_scroll' &&
                        window.App &&
                        window.App.vent &&
                        window.App.vent.trigger &&
                        typeof window.App.vent.trigger === 'function') {
                      App.vent.trigger('tracking:trackEvent', {
                          'category': eventCategory,
                          'action': eventAction,
                          'label': eventLabel,
                          'value': event
                      });
                    }
                };

            window._pq = window._pq || [];

            // Tracking Code for GAP's Google Analytics
            window.GAP_ANALYTICS = new App.tracker.EventManager({
                // 1 - Top Nav
                'click a.navbar-brand, .other-brands.dropdown a:not(.dropdown-toggle)': function () {
                    var dataBrand = $(this).data('brand');
                    var brand = "(Unknown)";
                    if (dataBrand && $.trim(dataBrand).length > 0) {
                        brand = dataBrand;
                    } else {
                        var textBrand = $.trim($(this).text().toLowerCase());
                        if (textBrand.length > 0 ) {
                            brand = textBrand;
                        }
                    }

                    recordEvent('gap_nav', 'nav', 'exit', 'nav - ' + brand);
                },
                // 2 - Header Logo
                'click header > a': function () {
                    recordEvent('header_logo', 'header', 'exit', 'gap.com');
                },
                // 3 - Social Subscribe Links
                'click .nav.navbar-nav.navbar-right a, .stay-connected .dropdown-menu a': function () {
                    var social_network = /(?:(\w+?)\.com)/.exec($(this).attr('href'))[1];
                    recordEvent('social_follow', 'follow', social_network + ' follow', 'follow');
                },
                // 4 - Main Visual
                'click #hero-area .jumbotron': function () {
                    recordEvent('main_visual', 'main visual', 'visual click', 'visual click');
                },
                // 5 - Feed Visuals
                'click .tile.product': function () {
                    productName = App.discovery.collection.get($(this).attr('id')).get('name');
                    recordEvent('product_feed', 'product_feed', 'pop-up open', productName);
                },
                // 6 - Product Social Links
                'click .content-wrapper .social-buttons .button': function () {
                    var social_network = $(this).attr('class').replace(/\s*button\s*/, '');
                    recordEvent('product_share', 'product pop-up', social_network + ' share', productName);
                },
                // 7 - Find Product in Store
                'click .content-wrapper a.button.find-store': function () {
                    recordEvent('product_find in store', 'product pop-up', 'find in store', productName);

                    try {
                        _pq.push(['track', 'FindInStore']);
                    } catch(err) {}

                    try {
                        __adroll.record_user({"adroll_segments": 'FindInStore'});
                    } catch(err) {}

                },
                // 8 - Buy Product Online
                'click .content-wrapper a.button.in-store': function () {
                    recordEvent('product_buy online', 'product pop-up', 'buy online', productName);

                    try {
                        _pq.push(['track', 'ShopOnGap']);
                    } catch(err) {}

                    try {
                        __adroll.record_user({"adroll_segments": 'ShopOnGap'});
                    } catch(err) {}

                },
                // 10 - Share deal
                'click #hero-area .buttons a': function () {
                    var social_network = /(?:(\w+?)\.com)/.exec($(this).attr('href'))[1];
                    recordEvent('deal_share', 'header', social_network + ' share', 'share page');
                },
                // 13 - Lifestyle Feed Visuals
                'click .tile.image': function () {
                    var cid = $(this).attr('id'),
                        obj = App.discovery.collection.get(cid),
                        products = obj.get('tagged-products');
                    if (products && products.length > 0) {
                        productName = products[0].name;
                        recordEvent('lifestyle_feed', 'lifestyle feed', 'pop-up open', productName);
                    } else {
                        productName = null;
                    }
                },
                // 14 - Lifestyle Product Social Links
                'click .image-with-tagged-products .social-buttons .button, .image-without-tagged-products .social-buttons .button': function () {
                    if (productName) {
                        var social_network = $(this).attr('class').replace(/\s*button\s*/, '');
                        recordEvent('lifestyle_share', 'lifestyle pop-up', social_network + ' share', productName);
                    }
                },
                // 15 - Find Lifestyle Product in Store
                'click .image-with-tagged-products a.button.find-store, .image-without-tagged-products a.button.find-store': function () {
                    if (productName) {
                        recordEvent('lifestyle_find in store', 'lifestyle pop-up', 'find in store', productName);
                    }
                },
                // 16 - Buy Lifestyle Product Online
                'click .image-with-tagged-products a.button.in-store, .image-without-tagged-products a.button.in-store \
                    .image-with-tagged-products a.buy, .image-without-tagged-products a.buy': function () {
                    if (productName) {
                        recordEvent('lifestyle_buy online', 'lifestyle pop-up', 'buy online', productName);
                    }
                },
                // 17 - Lifestyle Feed Video
                'click .tile.youtube.wide': function () {
                    var cid = $(this).attr('id'),
                        obj = App.discovery.collection.get(cid),
                        products = obj.get('tagged-products');
                    if (products && products.length > 0) {
                        recordEvent('lifestyle_video', 'lifestyle_feed', 'video play', products[0].name);
                    }
                },
                // 18 - Lifestyle Feed Video
                'click #hero-area .overlay .find a': function() {
                    recordEvent('find_store', 'main visual', 'store locator', 'find a store');
                },
                // Perfect Audience
                'click .tile': function() {
                    var cid = $(this).attr('id'),
                        obj = App.discovery.collection.get(cid),
                        page_id, store_slug, feed_id, tile_id;

                    tile_id = obj.get('tile-id');
                    page_id = App.options.page.id;
                    store_slug = App.options.store.slug;

                    // Needs to match the RSS
                    feed_id = store_slug + 'P' + page_id + 'T' + tile_id;

                    try {
                        _pq.push(['track', 'PopUp']);
                        _pq.push(['trackProduct', feed_id]);
                    } catch(err) {}

                    try {
                        __adroll.record_user({"adroll_segments": 'PopUp'});
                        __adroll.record_user({"product_id": feed_id});
                    } catch(err) {}
                }
            });

            // Subscribe to FB event for GAP Analytic tracking
            App.vent.on('tracking:registerFacebookListeners', function () {
                FB.Event.subscribe('edge.create', function(href, widget) {
                    var type = $('div.facebook').eq(0).parents('.image-with-tagged-products, .image-without-tagged-products');
                    if (productName && type && type.length > 0) {
                        recordEvent('lifestyle_share', 'lifestyle pop-up', 'facebook share', productName);
                    } else if (productName) {
                        recordEvent('product_share', 'product pop-up', 'facebook share', productName);
                    }
                });
            });

            var urlParams = App.options.urlParams;
            urlParams += urlParams.length ? "&" : "?";
            switch("{{ url|default:''|escapejs}}") {
                case "livedin":
                    App.options.urlParams = urlParams + "tid=gpme000028";
                    break;
                case "paddingtonbear":
                    App.options.urlParams = urlParams + "tid=gpme000029";
                    break;
                case "presidentsday":
                    App.options.urlParams = urlParams + "tid=gpme000030";
                    break;
            }
        }

        var wait = setInterval(function () {
            if (window.App) {
                clearInterval(wait);
                initGapAnalytics();
            }
        }, 100);
    </script>

    {% if environment == 'production' %}
    <!-- Google Tag Manager -->
    <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-NQTT"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-NQTT');</script>
    <!-- End Google Tag Manager -->
    {% else %}
    <script type='text/javascript'>
        (function() {
            var dataLayer = window.dataLayer = [];
        }());
    </script>
    {% endif %}

    <!-- Perfect Audience -->
    <script type="text/javascript">
      (function() {
        window._pa = window._pa || {};
        // _pa.orderId = "myOrderId"; // OPTIONAL: attach unique conversion identifier to conversions
        // _pa.revenue = "19.99"; // OPTIONAL: attach dynamic purchase values to conversions
        // _pa.productId = "myProductId"; // OPTIONAL: Include product ID for use with dynamic ads
        var pa = document.createElement('script'); pa.type = 'text/javascript'; pa.async = true;
        pa.src = ('https:' === document.location.protocol ? 'https:' : 'http:') + "//tag.perfectaudience.com/serve/535538ebd9a0e9beae000073.js";
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(pa, s);
      })();
    </script>

    <!-- AdRoll -->
    <script type="text/javascript">
    adroll_adv_id = "7HUSQEXE6ZBQTE6BZ2HE5B";
    adroll_pix_id = "JKZ3HVQNCVGQ7GONAFDN5O";
    (function () {
       __adroll_loaded=true;
       var scr = document.createElement("script");
       var host = (("https:" === document.location.protocol) ? "https://s.adroll.com" : "http://a.adroll.com");
       scr.setAttribute('async', 'true');
       scr.type = "text/javascript";
       scr.src = host + "/j/roundtrip.js";
       ((document.getElementsByTagName('head') || [null])[0] ||
        document.getElementsByTagName('script')[0].parentNode).appendChild(scr);
    }());
    </script>

    <!-- Dev Only -->
    <script type='text/javascript'>
        (function(){
            window.DEV_FUNCTIONS = {};
            window.DEV_FUNCTIONS.track_me = function() {
                // Track via AdRoll
                try {
                    // Segment must match that of AdRoll
                    __adroll.record_user({"adroll_segments": "developers"});
                } catch(err) {}

                // Track via Perfect Audience
                try {
                    window._pq = window._pq || [];
                    _pq.push(['track', 'developers']);
                } catch(err) {}
            }
        }());
    </script>
    <img src='{% url 'apps.tracking.views.pixel' %}'/>
</body>
</html>
