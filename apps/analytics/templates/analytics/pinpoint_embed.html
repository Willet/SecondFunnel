{% extends "analytics/base_embed.html" %}

{% load staticfiles %}

{% block extra_head %}
    {{ block.super }}
    <style type="text/css" media="screen">
        body {
            background: #dedede;
        }

        h2, .campaign_menu {
            font-family: Arial;
        }

        .campaign_menu {
            margin-top: 20px;
        }

        .campaign_analytics {
            border-left: 1px solid #bdbdbd;
            padding-left: 20px;
        }

        .campaign_menu ul {
            list-style: none;
        }

        .campaign_analytics ul {
            list-style: none;
            padding-left: 25px;
        }

        .campaign_analytics ul li {
            margin-left: 0px;
            font-family: Arial;
            font-size: 11pt;
            padding-top: 7px;
        }

        li .angled {
            padding-left: 20px;
            background: url("{% static "images/angled-line-13x13.png" %}");
            background-repeat: no-repeat;
            /*background-position: -1px 5px;*/
            /*border-left: 1px solid #000;*/
        }

        span.highlight {
            color: #3d3d3d;
            font-weight: bolder;
        }

        span.dimmed {
            color: #818181;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="grid_12">
        <div class="grid_2 alpha campaign_menu">
            <strong>All Pages</strong>
            <ul id="campaign_list"></ul>
        </div>

        <div class="grid_9 omega campaign_analytics">
            <div class="grid_9">
                <h2 id="analytics_title">All Pages</h2>

                <ul>
                    <li><span class="highlight">Visitors (<span id="visitors_count">&hellip;</span>)</span></li>
                    <li>
                        <ul>
                            <li class="angled"><span class="highlight" id="visitors_to_interaction">&hellip;</span> <span class="dimmed">(<span id="interaction_count">&hellip;</span>)</span> Interacted</li>
                            <li>
                                <ul>
                                    <li class="angled"><span class="highlight" id="social_shares_perc">&hellip;</span> <span class="dimmed">(<span id="social_shares_count">&hellip;</span>)</span> Social Shares</li>
                                    <li>
                                        <ul>
                                            <li class="angled"><span class="highlight" id="shared_featured_perc">&hellip;</span> <span class="dimmed">(<span id="shared_featured_count">&hellip;</span>)</span> Shared Featured</li>
                                            <li class="angled"><span class="highlight" id="shared_popup_perc">&hellip;</span> <span class="dimmed">(<span id="shared_popup_count">&hellip;</span>)</span> Shared Popup</li>
                                        </ul>
                                    </li>
                                    <li class="angled"><span class="highlight" id="open_popup_perc">&hellip;</span> <span class="dimmed">(<span id="open_popup_count">&hellip;</span>)</span> Previewed Product</li>
                                    <li class="angled"><span class="highlight" id="clickthrough_perc">&hellip;</span> <span class="dimmed">(<span id="clickthrough_count">&hellip;</span>)</span> Clicked "Buy Now"</li>
                                </ul>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>

            <div class="grid_9">
                <div id="analytics_chart" style="border: 1px solid #545454; width: 600px; height: 320px;"></div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    {{ block.super }}
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>

    <script type="text/javascript">
        var pages = window.parent.pages, current_analytics_app = "";
        // var pages = ["Page one", "Page two", "Campaign X"];

        function set_percentage(id, perc) {
            $("#" + id).html(perc.toFixed(2) + "%");
        }

        function loadAnalyticsData() {
            $.getJSON("{% url ajax-analytics-overview %}", {app_slug: "my-app"}, function(analytics_data) {
                var dataset = [['Year', 'Visits', 'Interactions']],
                i, google_data, google_options, chart, social_shares_count;

                $("#visitors_count").html(analytics_data.visits);
                $("#interaction_count").html(analytics_data.interactions.total);

                social_shares_count = analytics_data.interactions.shares.featured + analytics_data.interactions.shares.popup;
                $("#social_shares_count").html(social_shares_count);
                $("#shared_featured_count").html(analytics_data.interactions.shares.featured);
                $("#shared_popup_count").html(analytics_data.interactions.shares.popup);
                $("#open_popup_count").html(analytics_data.interactions.popup);
                $("#clickthrough_count").html(analytics_data.interactions.clickthrough);

                set_percentage("visitors_to_interaction", analytics_data.interactions.total / analytics_data.visits * 100);
                set_percentage("social_shares_perc", social_shares_count / analytics_data.interactions.total * 100);
                set_percentage("shared_featured_perc", analytics_data.interactions.shares.featured / social_shares_count * 100);
                set_percentage("shared_popup_perc", analytics_data.interactions.shares.popup / social_shares_count * 100);
                set_percentage("open_popup_perc", analytics_data.interactions.popup / analytics_data.interactions.total * 100);
                set_percentage("clickthrough_perc", analytics_data.interactions.clickthrough / analytics_data.interactions.total * 100);

                for (var i in analytics_data.daily) {
                    dataset.push([analytics_data.daily[i].date, analytics_data.daily[i].visits, analytics_data.daily[i].interactions.total]);
                }

                google_data = google.visualization.arrayToDataTable(dataset);

                google_options = {
                    title: 'Traffic Overview',
                    legend: {'position': 'bottom', 'fontSize': 16},
                    backgroundColor: "#e9e9e9",
                    chartArea: {width: '87%'},
                    colors: ["#8E9E82", "#607890"]
                    // theme: "maximized"
                };

                chart = new google.visualization.LineChart(document.getElementById('analytics_chart'));
                chart.draw(google_data, google_options);
            });
        }

        window.setInterval(function() {
            var analytics_app = window.parent.current_analytics_app;

            if (current_analytics_app == analytics_app) {
                return;
            }

            current_analytics_app = analytics_app;
            loadAnalyticsData();
        }, 500);

        google.load("visualization", "1", {packages:["corechart"]});
        google.setOnLoadCallback(function () {
            loadAnalyticsData();
        });

        $(function() {
            for (i in pages) {
                $("#campaign_list").append("<li>" + pages[i] + "</li>");
            }
        });
    </script>
{% endblock %}