<!-- DJANGO Template for displaying the results from the JSTestDriver/Jasmine tests. -->
{% load staticfiles %}
<!DOCTYPE html>
<html>
  <head>
      <title>Results</title>
      <script id="loading" type="text/template">
          <div style="text-align: center; margin: 0 auto; position: absolute; top: 50%; left:50%; margin-left:-70px; margin-top:-50px;">
              <h1>Testing...</h1>
              <img src='{% static "images/ajax-spinner.gif" %}' />
          </div>
      </script>
      <script id="config-select" type="text/template">
          <div class="popup">
              <span style="display:inline-block;"> Select configuration file to use: </span>
              <select name="configfiles" style="display:inline-block">
                  {% for config in configs %}
                  <option value="{{ config }}">{{ config }}</option>
                  {% endfor %}
              </select>
              <span style="display:inline-block;">Enter any browsers to use, seperated by space (if any): </span>
              <input name="browsers" value="" type="text" size="50" pattern="(\s*|\w+)">
          </div>
      </script>
      <link rel="stylesheet" href="{% static "testing/css/jstestdriver.css" %}" />
      <link rel="stylesheet" href="{% static "css/smoothness/jquery-ui.css" %}" />
      <script src="{% static "js/jquery-1.8.1.min.js" %}"></script>
      <script src="{% static "js/jquery-ui.js" %}"></script>
      <script type="text/javascript">
          (function($) {
              $(document).ready(function(){
                  $('body').on('click', '.ui-widget-overlay', function(){
                      $('.ui-dialog.ui-widget .popup').dialog('destroy');
                  });
          
                  $('input').click(function(){
                      var $elem = $('#' + $(this).attr('name'));
                      $elem = $elem.add($elem.prev());
                      $elem.toggle('slow');
                  });

                  $('a.test-spec').click(function(e) {
                      e.preventDefault();
                      var spec = $(this).attr('data-type-id');
            
                      if (spec.indexOf(".") > -1) {
                          // Tests specify browsers, strip the tag
                          spec = spec.split(",");
                          for ( var i = 0; i < spec.length; ++i ) {
                              var t = spec[i];
                              t = t.split(".");
                              t.shift();
                              t = t.join(".");
                              spec[i] = t;
                          }
                          spec = spec.join(",");
                      }
                      
                      $dialog = $($("#config-select").html());
                      $dialog.dialog({
                          modal: true,
                          width: 700,
                          buttons: [ 
                              { text: "OK", click: function() {
                                    var config = encodeURIComponent($(this).find('select').val() + ".yaml"),
                                        browsers = $(this).find('input').val();
                                    spec = encodeURIComponent(spec);
                                               
                                    $('body').empty();
                                    $('body').append($($("#loading").html()));
                                    
                                    var url = "update/?tests=" + spec + "&config=" + config;
                                    if (/\w+/g.test(browsers)) {
                                        url += "&browsers=" + encodeURIComponent(browsers);
                                    }

                                    $.get(url,
                                        function( data ) {
                                            if (data['success']) {
                                                window.location.reload(true);
                                            } else {
                                                alert("Something went wrong!");
                                                console.log(data['error']);
                                            }
                                        }
                                    );
                                 }
                             }
                          ],
                          title: "Select configuration",
                          close: function() {
                              $(this).dialog( "destroy" );
                          }
                      });
                  });
              });
          })(jQuery);
      </script>
</head>

  <body>
      <div id="title-bar">
          <h1>JsTestDriver Test Results</h1>
          <div class="show">
              <span><b>Show:</b> </span>
              {% block result-types %}
              {% endblock %}
          </div>
          <div style="float:right; position: relative; top: 2.5em; right: 2.5em; display:inline-block;">
              <b><a class="test-spec" href="#" style="text-decoration: none;" data-type-id="all">Run all Tests</a></b>
          </div>
          <div style="clear:both;"></div>
      </div>
      {# The results of the tests go here #}
      {% block results %}
      {% endblock %}
      {{ configs }}
  </body>

</html>
